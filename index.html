<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#05200b" />
  <meta name="description" content="Control de Mercaderistas - Supertiendas CaÃ±averal" />

  <!-- PWA Meta Tags -->
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="MercaControl" />

  <title>Control de Mercaderistas | Supertiendas CaÃ±averal</title>
  <link rel="manifest" href="/manifest.json" />

  <!-- MSAL - Microsoft Authentication -->
  <script src="https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.0/lib/msal-browser.min.js"></script>

  <!-- MSAL redirect handler - must run BEFORE React -->
  <script>
    window.__msalReady = false;
    window.__msalAccount = null;
    window.__msalError = null;
    function __initMsal() {
      const msalLib = window.msalBrowser || window.msal;
      if (!msalLib) { window.__msalReady = true; return; }
      const app = new msalLib.PublicClientApplication({
        auth: {
          clientId: "0652ef4a-cd47-4994-91ac-afbb86a8a2ba",
          authority: "https://login.microsoftonline.com/ae0b754a-1500-4ce6-b39e-59d483b9ae9c",
          redirectUri: window.location.origin + window.location.pathname.replace(/\/$/, ""),
        },
        cache: { cacheLocation: "sessionStorage", storeAuthStateInCookie: true },
      });
      window.__msalApp = app;
      app.handleRedirectPromise().then(res => {
        if (res && res.account) window.__msalAccount = res.account;
        else {
          const accounts = app.getAllAccounts();
          if (accounts.length > 0) window.__msalAccount = accounts[0];
        }
        window.__msalReady = true;
      }).catch(e => {
        window.__msalError = e.message;
        window.__msalReady = true;
      });
    }
    document.addEventListener("DOMContentLoaded", __initMsal);
  </script>

  <!-- React + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body, #root { height: 100%; }
    body { background: #05200b; overflow: hidden; }
    #splash {
      position: fixed; inset: 0; background: #05200b;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center; z-index: 9999;
      transition: opacity .5s ease;
    }
    #splash.hide { opacity: 0; pointer-events: none; }
    .splash-spinner {
      width: 36px; height: 36px; border: 3px solid rgba(125,209,5,.2);
      border-top-color: #7dd105; border-radius: 50%;
      animation: spin .8s linear infinite; margin-top: 20px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <!-- Splash screen -->
  <div id="splash">
    <div style="font-family:sans-serif; text-align:center; color:#fff;">
      <div style="font-size:13px; color:rgba(255,255,255,.5); letter-spacing:2px; text-transform:uppercase; margin-bottom:8px;">Supertiendas CaÃ±averal</div>
      <div style="font-size:17px; font-weight:700; color:#7dd105;">Control de Mercaderistas</div>
      <div class="splash-spinner"></div>
    </div>
  </div>

  <div id="root"></div>

  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => console.log('SW registrado:', reg.scope))
          .catch(err => console.log('SW error:', err));
      });
    }
    // Hide splash after app loads
    window.addEventListener('load', () => {
      setTimeout(() => {
        const s = document.getElementById('splash');
        if (s) { s.classList.add('hide'); setTimeout(() => s.remove(), 500); }
      }, 800);
    });
  </script>

  <!-- App -->
  <script type="text/babel">
const { useState, useEffect, useCallback, useMemo, useRef } = React;

// â”€â”€â”€ Azure AD / MSAL Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MSAL_CLIENT_ID = "0652ef4a-cd47-4994-91ac-afbb86a8a2ba";
const MSAL_TENANT_ID = "ae0b754a-1500-4ce6-b39e-59d483b9ae9c";
const SP_HOST        = "https://stcanaveral.sharepoint.com";
const SP_SITE_PATH   = "";  // vacÃ­o = sitio raÃ­z. Ej: "/sites/MiSitio"
const GRAPH          = "https://graph.microsoft.com/v1.0";

// Nombres de listas en SharePoint (se crean solas si no existen)
const SP_LISTS = {
  "mreg-v1-registros":  "MercaControl_Registros",
  "mreg-v1-empresas":   "MercaControl_Empresas",
  "mreg-v1-sedes":      "MercaControl_Sedes",
  "mreg-v1-admins":     "MercaControl_Admins",
  "mreg-v1-viewers":    "MercaControl_Viewers",
  "mreg-v1-guardias":   "MercaControl_Guardias",
  "mreg-v1-comercials": "MercaControl_Comercials",
  "mreg-v1-acuerdos":   "MercaControl_Acuerdos",
};

let msalInstance = null;
function getMsal() {
  if (window.__msalApp) return window.__msalApp;
  if (!msalInstance) {
    const msalLib = window.msalBrowser || window.msal;
    msalInstance = new msalLib.PublicClientApplication({
      auth: {
        clientId: MSAL_CLIENT_ID,
        authority: `https://login.microsoftonline.com/${MSAL_TENANT_ID}`,
        redirectUri: window.location.origin + window.location.pathname.replace(/\/$/, ""),
      },
      cache: { cacheLocation: "sessionStorage", storeAuthStateInCookie: true },
    });
  }
  return msalInstance;
}

const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

// Token con permisos Graph/SharePoint
async function getToken() {
  const app      = getMsal();
  const accounts = app.getAllAccounts();
  if (!accounts.length) throw new Error("No hay sesiÃ³n activa");
  const req = { scopes: ["Sites.ReadWrite.All", "User.Read"], account: accounts[0] };
  try   { return (await app.acquireTokenSilent(req)).accessToken; }
  catch { return (await app.acquireTokenPopup(req)).accessToken;  }
}

// Cache siteId
let _siteId = null;
async function getSiteId(token) {
  if (_siteId) return _siteId;
  const host = SP_HOST.replace("https://", "");
  const path = SP_SITE_PATH || "/";
  const res  = await fetch(`${GRAPH}/sites/${host}:${path}`, {
    headers: { Authorization: `Bearer ${token}` }
  });
  const d = await res.json();
  if (!d.id) throw new Error("No se pudo obtener siteId: " + JSON.stringify(d));
  _siteId = d.id;
  return _siteId;
}

// Cache listIds
const _listIds = {};
async function getListId(token, siteId, listName) {
  if (_listIds[listName]) return _listIds[listName];
  const res  = await fetch(`${GRAPH}/sites/${siteId}/lists/${listName}`, {
    headers: { Authorization: `Bearer ${token}` }
  });
  const d = await res.json();
  if (d.id) { _listIds[listName] = d.id; return d.id; }
  // Crear lista si no existe
  const cr = await fetch(`${GRAPH}/sites/${siteId}/lists`, {
    method: "POST",
    headers: { Authorization: `Bearer ${token}`, "Content-Type": "application/json" },
    body: JSON.stringify({ displayName: listName, list: { template: "genericList" }, columns: [{ name: "Data", text: {} }] })
  });
  const created = await cr.json();
  _listIds[listName] = created.id;
  return created.id;
}

// Leer dato de SharePoint (1 Ã­tem con campo Data = JSON)
async function spRead(listName) {
  try {
    const token  = await getToken();
    const siteId = await getSiteId(token);
    const listId = await getListId(token, siteId, listName);
    const res    = await fetch(
      `${GRAPH}/sites/${siteId}/lists/${listId}/items?$expand=fields($select=Data)&$top=1`,
      { headers: { Authorization: `Bearer ${token}` } }
    );
    const d = await res.json();
    if (d.value?.length > 0) {
      const raw = d.value[0].fields?.Data;
      if (raw) return JSON.parse(raw);
    }
    return null;
  } catch (e) { console.warn("spRead error:", listName, e.message); return null; }
}

// Escribir dato en SharePoint (upsert)
const _itemIds = {};
async function spWrite(listName, value) {
  try {
    const token   = await getToken();
    const siteId  = await getSiteId(token);
    const listId  = await getListId(token, siteId, listName);
    const headers = { Authorization: `Bearer ${token}`, "Content-Type": "application/json" };
    const body    = JSON.stringify({ fields: { Data: JSON.stringify(value) } });

    if (_itemIds[listName]) {
      await fetch(`${GRAPH}/sites/${siteId}/lists/${listId}/items/${_itemIds[listName]}`,
        { method: "PATCH", headers, body });
    } else {
      const res = await fetch(
        `${GRAPH}/sites/${siteId}/lists/${listId}/items?$select=id&$top=1`,
        { headers: { Authorization: `Bearer ${token}` } }
      );
      const d = await res.json();
      if (d.value?.length > 0) {
        _itemIds[listName] = d.value[0].id;
        await fetch(`${GRAPH}/sites/${siteId}/lists/${listId}/items/${_itemIds[listName]}`,
          { method: "PATCH", headers, body });
      } else {
        const cr = await fetch(`${GRAPH}/sites/${siteId}/lists/${listId}/items`,
          { method: "POST", headers, body });
        const created = await cr.json();
        _itemIds[listName] = created.id;
      }
    }
  } catch (e) { console.warn("spWrite error:", listName, e.message); }
}

// â”€â”€â”€ Storage Hook â€” SharePoint + localStorage cachÃ© offline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function useSharedStorage(key, initial) {
  const listName  = SP_LISTS[key];
  const [val, setVal]       = useState(() => {
    try { const s = localStorage.getItem(key); return s ? JSON.parse(s) : initial; }
    catch { return initial; }
  });
  const [loaded, setLoaded] = useState(false);
  const didLoad             = useRef(false);

  useEffect(() => {
    if (didLoad.current || !listName) { setLoaded(true); return; }
    didLoad.current = true;
    spRead(listName).then(remote => {
      if (remote !== null) {
        setVal(remote);
        localStorage.setItem(key, JSON.stringify(remote));
      }
      setLoaded(true);
    });
  }, [key, listName]);

  const save = useCallback(async (v) => {
    const next = typeof v === "function" ? v(val) : v;
    setVal(next);
    localStorage.setItem(key, JSON.stringify(next));
    if (listName) spWrite(listName, next);
    return next;
  }, [key, listName, val]);

  return [val, save, loaded];
}

// â”€â”€â”€ Online/Offline Hook â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function useOnlineStatus() {
  const [online, setOnline] = useState(() => navigator.onLine);
  useEffect(() => {
    const on  = () => setOnline(true);
    const off = () => setOnline(false);
    window.addEventListener("online",  on);
    window.addEventListener("offline", off);
    return () => { window.removeEventListener("online", on); window.removeEventListener("offline", off); };
  }, []);
  return online;
}

// â”€â”€â”€ Offline Banner Component â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function OfflineBanner({ online, pending, onSync, syncing }) {
  if (online && pending === 0) return null;
  return (
    <div style={{
      background: online ? "#f0fcd4" : "#05200b",
      borderBottom: `2px solid ${online ? "#7dd105" : "#1C5A2A"}`,
      padding: "8px 20px",
      display: "flex", alignItems: "center", justifyContent: "space-between",
      flexShrink: 0, transition: "all .3s"
    }}>
      <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
        {/* Animated dot */}
        <div style={{
          width: 10, height: 10, borderRadius: "50%",
          background: online ? "#7dd105" : "#ef4444",
          boxShadow: online ? "0 0 0 3px rgba(125,209,5,.25)" : "0 0 0 3px rgba(239,68,68,.25)",
          animation: "pulse 2s infinite"
        }} />
        <div>
          <span style={{ fontWeight: 800, fontSize: 13, color: online ? "#3a6200" : "#fff" }}>
            {online ? "ConexiÃ³n restaurada" : "Sin conexiÃ³n â€” Modo offline activo"}
          </span>
          {pending > 0 && (
            <span style={{
              marginLeft: 10, background: online ? "#7dd105" : "#1C5A2A",
              color: online ? "#05200b" : "#fff",
              borderRadius: 99, padding: "1px 9px", fontSize: 11, fontWeight: 800
            }}>
              {pending} registro{pending !== 1 ? "s" : ""} pendiente{pending !== 1 ? "s" : ""}
            </span>
          )}
        </div>
      </div>
      <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
        {!online && (
          <span style={{ fontSize: 12, color: "rgba(255,255,255,.6)" }}>
            Los registros se guardan localmente âœ“
          </span>
        )}
        {online && pending > 0 && (
          <button onClick={onSync} disabled={syncing} style={{
            background: "#7dd105", border: "none", color: "#05200b",
            padding: "5px 14px", borderRadius: 8, fontWeight: 800, fontSize: 12,
            cursor: "pointer", display: "flex", alignItems: "center", gap: 6
          }}>
            {syncing ? <Spinner /> : "â†‘"} {syncing ? "Sincronizando..." : "Sincronizar ahora"}
          </button>
        )}
      </div>
    </div>
  );
}

// â”€â”€â”€ Micro Components â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Badge({ tipo, size = "md" }) {
  const big = size === "lg";
  return (
    <span style={{
      display: "inline-flex", alignItems: "center", gap: 4,
      background: tipo === "entrada" ? T.greenLight : T.redLight,
      color: tipo === "entrada" ? T.green : T.red,
      border: `1px solid ${tipo === "entrada" ? "#a7f3d0" : "#fecaca"}`,
      padding: big ? "6px 14px" : "3px 10px",
      borderRadius: 99, fontSize: big ? 14 : 12, fontWeight: 700,
    }}>
      {tipo === "entrada" ? "â†‘" : "â†“"} {tipo === "entrada" ? "ENTRADA" : "SALIDA"}
    </span>
  );
}

function InfoRow({ label, value }) {
  return (
    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "11px 16px", borderBottom: `1px solid ${T.border}` }}>
      <span style={{ fontSize: 13, color: T.slate }}>{label}</span>
      <span style={{ fontSize: 13, fontWeight: 600, color: T.navyMid, maxWidth: "60%", textAlign: "right" }}>{value || "â€”"}</span>
    </div>
  );
}

function Spinner() {
  return <div style={{ width: 20, height: 20, border: `2px solid rgba(255,255,255,.3)`, borderTopColor: "#fff", borderRadius: "50%", animation: "spin .7s linear infinite" }} />;
}

// â”€â”€â”€ Login Screen (Microsoft 365 real) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function LoginScreen({ onLogin, admins, viewers, sedes, guardias, comercials }) {
  const [loading, setLoading] = useState(false);
  const [error, setError]     = useState("");

  const resolveAccount = (account) => {
    const email  = account.username?.toLowerCase() || "";
    const nombre = account.name || email;
    if (admins.some(a => a.email?.toLowerCase() === email)) {
      onLogin({ id: email, nombre, email, rol: "admin", sedeId: null }); return;
    }
    if (viewers.some(v => v.email?.toLowerCase() === email)) {
      onLogin({ id: email, nombre, email, rol: "viewer", sedeId: null }); return;
    }
    if ((comercials || []).some(c => c.email?.toLowerCase() === email)) {
      onLogin({ id: email, nombre, email, rol: "comercial", sedeId: null }); return;
    }
    const guardia = (guardias || []).find(g => g.email?.toLowerCase() === email);
    if (guardia) {
      onLogin({ id: email, nombre, email, rol: "security", sedeId: guardia.sedeId }); return;
    }
    setError("Tu cuenta no tiene acceso asignado. Contacta al administrador.");
    try { getMsal().logoutRedirect(); } catch(_) {}
  };

  // Handle redirect response on page load (mobile)
  useEffect(() => {
    // If index.html already resolved the account before React mounted
    if (window.__msalAccount) {
      resolveAccount(window.__msalAccount);
      window.__msalAccount = null;
      return;
    }
    if (window.__msalError) {
      setError("Error al iniciar sesiÃ³n: " + window.__msalError);
      window.__msalError = null;
      return;
    }
    // Fallback: try handleRedirectPromise ourselves
    getMsal().handleRedirectPromise()
      .then(res => {
        if (res && res.account) { resolveAccount(res.account); return; }
        const accounts = getMsal().getAllAccounts();
        if (accounts.length > 0) resolveAccount(accounts[0]);
      })
      .catch(e => setError("Error: " + (e.message || "intenta de nuevo")));
  }, []); // eslint-disable-line

  const handleMicrosoftLogin = async () => {
    setError("");
    setLoading(true);
    const req = { scopes: ["User.Read", "openid", "profile"], prompt: "select_account" };
    try {
      const app = getMsal();
      await app.loginRedirect(req); // redirect for everyone - no popups
      return;
    } catch (e) {
      if (e.errorCode !== "user_cancelled") {
        setError("Error al iniciar sesiÃ³n: " + (e.message || e.errorCode || "intenta de nuevo"));
      }
    }
    setLoading(false);
  };

  return (
    <div style={{ minHeight: "100vh", background: "#05200b", display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", padding: 24 }}>
      <div style={{ width: "100%", maxWidth: 420 }}>
        <div style={{ textAlign: "center", marginBottom: 36 }}>
          <img src={LOGO_SRC} alt="Supertiendas CaÃ±averal"
            style={{ width: 120, height: 120, borderRadius: "50%", objectFit: "cover", boxShadow: "0 8px 32px rgba(0,0,0,.4)", border: "3px solid rgba(255,255,255,.15)", marginBottom: 16 }} />
          <h1 style={{ color: "#fff", fontSize: 26, fontWeight: 900, letterSpacing: -0.5 }}>Control de Mercaderistas</h1>
          <p style={{ color: T.muted, fontSize: 13, marginTop: 6, fontStyle: "italic", lineHeight: 1.5 }}>
            "Alimentando familias y sirviendo con amor"
          </p>
        </div>
        <div style={{ background: "#0a2e10", borderRadius: 16, padding: 24, border: `1px solid rgba(255,255,255,.1)` }}>
          <p style={{ color: T.muted, fontSize: 12, fontWeight: 700, textTransform: "uppercase", letterSpacing: 1, marginBottom: 18, textAlign: "center" }}>
            Inicia sesiÃ³n con tu cuenta corporativa
          </p>
          <button onClick={handleMicrosoftLogin} disabled={loading} style={{
            width: "100%", padding: "16px", borderRadius: 12, border: "none",
            background: loading ? "#334155" : T.amber,
            color: loading ? T.muted : T.navy,
            fontSize: 15, fontWeight: 800, cursor: loading ? "not-allowed" : "pointer",
            transition: "all .2s",
            display: "flex", alignItems: "center", justifyContent: "center", gap: 10
          }}>
            {loading ? <Spinner /> : <span style={{ fontSize: 20 }}>âŠ</span>}
            {loading ? "Conectando..." : "Iniciar sesiÃ³n con Microsoft"}
          </button>
          {error && (
            <div style={{ marginTop: 14, background: "rgba(239,68,68,.1)", border: "1px solid rgba(239,68,68,.3)", borderRadius: 8, padding: "10px 14px", color: "#fca5a5", fontSize: 13 }}>
              {error}
            </div>
          )}
          <p style={{ textAlign: "center", color: T.muted, fontSize: 11, marginTop: 14 }}>
            AutenticaciÃ³n segura vÃ­a Azure AD Â· @stcanaveral.com
          </p>
        </div>
      </div>
    </div>
  );
}

// â”€â”€â”€ Nuevo Registro Form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function NuevoRegistroForm({ user, sedes, empresas, registros, onSave, onCancel }) {
  const [tipo, setTipo] = useState("");
  const [empresaId, setEmpresaId] = useState("");
  const [busqueda, setBusqueda] = useState("");
  const [sedeIdSel, setSedeIdSel] = useState(user.sedeId || "");
  const [gps, setGps] = useState(null);
  const [gpsMsg, setGpsMsg] = useState("Obteniendo...");
  const [saving, setSaving] = useState(false);
  const [now, setNow] = useState(new Date());
  const [showList, setShowList] = useState(false);

  const isAdmin = !user.sedeId; // admin no tiene sede fija
  const sedesActivas = useMemo(() => sedes.filter(s => s.activa), [sedes]);
  const sedeMostrada = sedes.find(s => s.id === sedeIdSel);
  const empActivas = useMemo(() => empresas.filter(e => e.activa), [empresas]);
  const empFiltradas = useMemo(() =>
    empActivas.filter(e => e.nombre.toLowerCase().includes(busqueda.toLowerCase())),
    [empActivas, busqueda]);
  const empSel = empActivas.find(e => e.id === empresaId);

  useEffect(() => {
    const t = setInterval(() => setNow(new Date()), 1000);
    return () => clearInterval(t);
  }, []);

  useEffect(() => {
    if (!navigator.geolocation) { setGpsMsg("No disponible"); return; }
    navigator.geolocation.getCurrentPosition(
      pos => setGps({ lat: pos.coords.latitude.toFixed(6), lng: pos.coords.longitude.toFixed(6) }),
      () => setGpsMsg("No disponible")
    );
  }, []);

  const handleSave = async () => {
    if (!tipo || !empresaId || !sedeIdSel) return;
    setSaving(true);
    await onSave({ tipo, empresa: empSel.nombre, empresaId, gps, sedeIdOverride: isAdmin ? sedeIdSel : null });
    setSaving(false);
  };

  const canSave = tipo && empresaId && sedeIdSel;

  return (
    <div style={{ minHeight: "100vh", background: T.bg, fontFamily: "'Plus Jakarta Sans', sans-serif" }}>
      {/* Header */}
      <div style={{ background: T.navy, padding: "16px 20px", display: "flex", alignItems: "center", gap: 14 }}>
        <button onClick={onCancel} style={{
          background: "rgba(255,255,255,.1)", border: "none", color: "#fff",
          width: 40, height: 40, borderRadius: 10, fontSize: 20, cursor: "pointer",
          display: "flex", alignItems: "center", justifyContent: "center"
        }}>â†</button>
        <div>
          <div style={{ color: "#fff", fontSize: 18, fontWeight: 800 }}>Nuevo Registro</div>
          <div style={{ color: T.muted, fontSize: 12 }}>
            {isAdmin ? <span style={{ color: T.amber }}>ğŸ‘‘ Admin Â· Selecciona la sede</span> : sedeMostrada?.nombre}
          </div>
        </div>
      </div>

      <div style={{ padding: 20, maxWidth: 560, margin: "0 auto" }}>
        {/* Auto data card */}
        <div style={{ background: T.white, borderRadius: 14, overflow: "hidden", marginBottom: 20, border: `1px solid ${T.border}`, boxShadow: "0 1px 4px rgba(0,0,0,.05)" }}>
          <div style={{ padding: "12px 16px", background: T.navyMid, display: "flex", alignItems: "center", gap: 8 }}>
            <div className="pulse-dot" />
            <span style={{ color: "#fff", fontSize: 12, fontWeight: 700, textTransform: "uppercase", letterSpacing: 1 }}>Datos automÃ¡ticos</span>
          </div>
          <InfoRow label="ğŸ“… Fecha" value={fmtDate(now)} />
          <InfoRow label="â° Hora" value={<span style={{ fontFamily: "'JetBrains Mono', monospace", fontSize: 14 }}>{fmtTime(now)}</span>} />
          <InfoRow label="ğŸ¢ Sede" value={sedeMostrada?.nombre || "â€”"} />
          <InfoRow label="ğŸ‘¤ Registrado por" value={user.nombre} />
          <InfoRow label="ğŸ“ UbicaciÃ³n GPS" value={gps ? `${gps.lat}, ${gps.lng}` : gpsMsg} />
        </div>

        {/* Sede selector â€” solo admin */}
        {isAdmin && (
          <div style={{ marginBottom: 20 }}>
            <p style={{ fontSize: 13, fontWeight: 700, color: T.navyMid, marginBottom: 10, textTransform: "uppercase", letterSpacing: .5 }}>
              Sede *
            </p>
            <select value={sedeIdSel} onChange={e => setSedeIdSel(e.target.value)}
              style={{
                width: "100%", padding: "14px 16px", borderRadius: 12,
                border: `2px solid ${sedeIdSel ? T.navyMid : T.border}`,
                fontSize: 14, background: T.white, cursor: "pointer",
                color: sedeIdSel ? T.navyMid : T.muted
              }}>
              <option value="">Seleccionar sede...</option>
              {sedesActivas.map(s => <option key={s.id} value={s.id}>{s.nombre}</option>)}
            </select>
          </div>
        )}

        {/* Tipo movimiento */}
        <div style={{ marginBottom: 20 }}>
          <p style={{ fontSize: 13, fontWeight: 700, color: T.navyMid, marginBottom: 10, textTransform: "uppercase", letterSpacing: .5 }}>
            Tipo de movimiento *
          </p>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
            {[
              { v: "entrada", label: "â†‘ ENTRADA", bg: T.greenLight, border: T.green, text: T.green },
              { v: "salida", label: "â†“ SALIDA", bg: T.redLight, border: T.red, text: T.red },
            ].map(opt => (
              <button key={opt.v} onClick={() => setTipo(opt.v)} style={{
                padding: "22px 10px", borderRadius: 14, cursor: "pointer", fontWeight: 900,
                fontSize: 20, letterSpacing: 1,
                border: `2px solid ${tipo === opt.v ? opt.border : T.border}`,
                background: tipo === opt.v ? opt.bg : T.white,
                color: tipo === opt.v ? opt.text : T.muted,
                transition: "all .15s",
                boxShadow: tipo === opt.v ? `0 4px 16px ${opt.border}30` : "none"
              }}>{opt.label}</button>
            ))}
          </div>
        </div>

        {/* Empresa */}
        <div style={{ marginBottom: 28 }}>
          <p style={{ fontSize: 13, fontWeight: 700, color: T.navyMid, marginBottom: 10, textTransform: "uppercase", letterSpacing: .5 }}>
            Empresa *
          </p>
          <div style={{ position: "relative" }}>
            <input
              value={busqueda}
              onChange={e => { setBusqueda(e.target.value); setEmpresaId(""); setShowList(true); }}
              onFocus={() => setShowList(true)}
              placeholder="Buscar empresa..."
              style={{
                width: "100%", padding: "14px 16px", borderRadius: 12,
                border: `2px solid ${empresaId ? T.navyMid : T.border}`,
                fontSize: 14, outline: "none", background: T.white, fontFamily: "'Plus Jakarta Sans', sans-serif"
              }}
            />
            {showList && busqueda && !empresaId && (
              <div style={{
                position: "absolute", top: "100%", left: 0, right: 0, zIndex: 50,
                background: T.white, border: `1px solid ${T.border}`, borderRadius: 12,
                maxHeight: 240, overflowY: "auto", boxShadow: "0 8px 32px rgba(0,0,0,.12)",
                marginTop: 4
              }}>
                {empFiltradas.length === 0 && (
                  <div style={{ padding: 16, textAlign: "center", color: T.muted, fontSize: 13 }}>Sin resultados</div>
                )}
                {empFiltradas.map(e => (
                  <div key={e.id} onClick={() => { setEmpresaId(e.id); setBusqueda(e.nombre); setShowList(false); }}
                    style={{
                      padding: "12px 16px", cursor: "pointer", fontSize: 14,
                      borderBottom: `1px solid ${T.border}`,
                      transition: "background .1s"
                    }}
                    onMouseEnter={ev => ev.target.style.background = T.bg}
                    onMouseLeave={ev => ev.target.style.background = ""}
                  >{e.nombre}</div>
                ))}
              </div>
            )}
            {empSel && (
              <div style={{ marginTop: 8, padding: "10px 14px", background: T.navyMid, borderRadius: 10, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                <span style={{ color: "#fff", fontSize: 14, fontWeight: 600 }}>âœ“ {empSel.nombre}</span>
                <button onClick={() => { setEmpresaId(""); setBusqueda(""); }} style={{ background: "none", border: "none", color: T.amber, cursor: "pointer", fontSize: 18 }}>Ã—</button>
              </div>
            )}
          </div>
        </div>

        <button onClick={handleSave} disabled={!canSave || saving} style={{
          width: "100%", padding: "18px", borderRadius: 14, border: "none",
          background: canSave ? "#7dd105" : T.border,
          color: canSave ? "#05200b" : T.muted,
          fontSize: 16, fontWeight: 800, cursor: canSave ? "pointer" : "not-allowed",
          display: "flex", alignItems: "center", justifyContent: "center", gap: 10,
          boxShadow: canSave ? "0 4px 20px rgba(125,209,5,.35)" : "none",
          transition: "all .2s"
        }}>
          {saving ? <Spinner /> : "âœ…"} {saving ? "Guardando..." : "Confirmar Registro"}
        </button>
      </div>
    </div>
  );
}

// â”€â”€â”€ Security View â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function SecurityView({ user, sedes, empresas, registros, onNuevoRegistro, onLogout, online, pendingCount, syncing, onSync, viewAsBar }) {
  const [showForm, setShowForm] = useState(false);
  const [now, setNow] = useState(new Date());
  useEffect(() => { const t = setInterval(() => setNow(new Date()), 1000); return () => clearInterval(t); }, []);

  const sede = sedes.find(s => s.id === user.sedeId);
  const hoy = registros
    .filter(r => new Date(r.timestamp).toDateString() === now.toDateString() && r.sedeId === user.sedeId)
    .sort((a, b) => b.timestamp - a.timestamp);

  if (showForm) return (
    <NuevoRegistroForm user={user} sedes={sedes} empresas={empresas} registros={registros}
      onSave={async (d) => { await onNuevoRegistro(d); setShowForm(false); }}
      onCancel={() => setShowForm(false)} />
  );

  return (
    <div style={{ minHeight: "100vh", background: T.bg, display: "flex", flexDirection: "column" }}>
      <OfflineBanner online={online} pending={pendingCount} onSync={onSync} syncing={syncing} />
      {viewAsBar}
      {/* Header */}
      <div style={{ background: T.navy, padding: "18px 20px" }}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
          <div>
            <div style={{ marginBottom: 4 }}>
              <img src={LOGO_SRC} alt="CaÃ±averal" style={{ height: 30, width: 30, borderRadius: "50%", objectFit: "cover", border: "2px solid rgba(255,255,255,.15)" }} />
            </div>
            <div style={{ color: "#fff", fontSize: 22, fontWeight: 900 }}>{sede?.nombre || "Mi Sede"}</div>
            <div style={{ color: T.muted, fontSize: 13, marginTop: 2 }}>ğŸ‘¤ {user.nombre}</div>
          </div>
          <div style={{ textAlign: "right" }}>
            <div style={{ color: "#fff", fontSize: 36, fontWeight: 900, fontFamily: "'JetBrains Mono', monospace", lineHeight: 1 }}>
              {now.toLocaleTimeString("es-CO", { hour: "2-digit", minute: "2-digit" })}
            </div>
            <div style={{ color: T.muted, fontSize: 12, marginTop: 2 }}>
              {now.toLocaleDateString("es-CO", { weekday: "short", day: "2-digit", month: "short" })}
            </div>
            <button onClick={onLogout} style={{
              marginTop: 8, background: "rgba(255,255,255,.1)", border: "none",
              color: T.muted, fontSize: 11, padding: "4px 12px", borderRadius: 20, cursor: "pointer"
            }}>Salir</button>
          </div>
        </div>

        {/* Stats */}
        <div style={{ display: "flex", gap: 12, marginTop: 16 }}>
          {[
            { label: "Total hoy", val: hoy.length, color: "#fff" },
            { label: "Entradas", val: hoy.filter(r => r.tipo === "entrada").length, color: "#6ee7b7" },
            { label: "Salidas", val: hoy.filter(r => r.tipo === "salida").length, color: "#fca5a5" },
          ].map(s => (
            <div key={s.label} style={{ background: "rgba(255,255,255,.07)", borderRadius: 10, padding: "10px 16px", flex: 1, textAlign: "center" }}>
              <div style={{ color: s.color, fontSize: 28, fontWeight: 900, fontFamily: "'JetBrains Mono',monospace" }}>{s.val}</div>
              <div style={{ color: T.muted, fontSize: 11 }}>{s.label}</div>
            </div>
          ))}
        </div>
      </div>

      <div style={{ padding: 20 }}>
        <button onClick={() => setShowForm(true)} style={{
          width: "100%", padding: "22px", borderRadius: 16, border: "none",
          background: `linear-gradient(135deg, ${T.brand} 0%, ${T.brandAccent} 100%)`,
          color: T.navy, fontSize: 22, fontWeight: 900, cursor: "pointer",
          boxShadow: "0 6px 24px rgba(245,158,11,.4)",
          display: "flex", alignItems: "center", justifyContent: "center", gap: 14,
          marginBottom: 24, letterSpacing: .5
        }}>
          <span style={{ fontSize: 32 }}>+</span> NUEVO REGISTRO
        </button>

        <h3 style={{ fontSize: 14, fontWeight: 700, color: T.slate, textTransform: "uppercase", letterSpacing: 1, marginBottom: 12 }}>
          Movimientos de hoy
        </h3>

        {hoy.length === 0 && (
          <div style={{ textAlign: "center", padding: "48px 20px", color: T.muted }}>
            <div style={{ fontSize: 48, marginBottom: 8 }}>ğŸ“‹</div>
            <div style={{ fontSize: 15, fontWeight: 600 }}>Sin movimientos registrados hoy</div>
          </div>
        )}

        {hoy.map(r => (
          <div key={r.id} className="fade-in" style={{
            background: T.white, borderRadius: 12, padding: "14px 16px", marginBottom: 10,
            display: "flex", justifyContent: "space-between", alignItems: "center",
            boxShadow: "0 1px 4px rgba(0,0,0,.05)",
            borderLeft: `4px solid ${r.tipo === "entrada" ? T.green : T.red}`
          }}>
            <div>
              <div style={{ fontSize: 15, fontWeight: 700, color: T.navyMid }}>{r.empresa}</div>
              <div style={{ fontSize: 12, color: T.muted, marginTop: 2 }}>
                <span style={{ fontFamily: "'JetBrains Mono',monospace" }}>#{String(r.consecutivo).padStart(4, "0")}</span>
                {" Â· "}{fmtTime(r.timestamp)}
              </div>
            </div>
            <Badge tipo={r.tipo} />
          </div>
        ))}
      </div>
    </div>
  );
}

// â”€â”€â”€ Detail Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function DetailModal({ reg, onClose, onEdit, onDelete, isAdmin }) {
  const [confirmDelete, setConfirmDelete] = useState(false);
  if (!reg) return null;
  return (
    <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,.55)", zIndex: 100, display: "flex", alignItems: "center", justifyContent: "center", padding: 20 }}
      onClick={e => e.target === e.currentTarget && onClose()}>
      <div className="fade-in" style={{ background: T.white, borderRadius: 18, width: "100%", maxWidth: 460, maxHeight: "90vh", overflowY: "auto", boxShadow: "0 24px 64px rgba(0,0,0,.25)" }}>
        <div style={{ padding: "20px 20px 0", display: "flex", justifyContent: "space-between", alignItems: "center" }}>
          <span style={{ fontSize: 12, fontWeight: 700, color: T.muted, textTransform: "uppercase", letterSpacing: 1 }}>
            Detalle del movimiento
          </span>
          <button onClick={onClose} style={{ background: T.bg, border: "none", width: 32, height: 32, borderRadius: 8, cursor: "pointer", fontSize: 18, color: T.slate }}>Ã—</button>
        </div>

        <div style={{ padding: "16px 20px 20px", textAlign: "center", borderBottom: `1px solid ${T.border}` }}>
          <Badge tipo={reg.tipo} size="lg" />
          <div style={{ fontSize: 24, fontWeight: 900, color: T.navy, marginTop: 10 }}>{reg.empresa}</div>
          <div style={{ fontSize: 13, color: T.muted, marginTop: 4, fontFamily: "'JetBrains Mono',monospace" }}>
            Reg. #{String(reg.consecutivo).padStart(4, "0")}
          </div>
        </div>

        <div>
          <InfoRow label="ğŸ“… Fecha" value={fmtDate(reg.timestamp)} />
          <InfoRow label="â° Hora" value={fmtTime(reg.timestamp)} />
          <InfoRow label="ğŸ¢ Sede" value={reg.sedeName} />
          <InfoRow label="ğŸ‘¤ Guardia" value={reg.guardiaName} />
          <InfoRow label="ğŸ“ GPS" value={reg.gps ? `${reg.gps.lat}, ${reg.gps.lng}` : "No disponible"} />
        </div>

        {reg.gps && (
          <div style={{ padding: "12px 16px" }}>
            <a href={`https://maps.google.com/?q=${reg.gps.lat},${reg.gps.lng}`} target="_blank" rel="noreferrer"
              style={{ display: "block", textAlign: "center", padding: 12, background: T.blueLight, borderRadius: 10, color: T.blue, fontSize: 13, fontWeight: 700, textDecoration: "none" }}>
              ğŸ—ºï¸ Ver ubicaciÃ³n en Google Maps
            </a>
          </div>
        )}

        {isAdmin && !confirmDelete && (
          <div style={{ padding: "0 16px 16px", display: "flex", gap: 10 }}>
            <button onClick={() => onEdit(reg)} style={{
              flex: 1, padding: 12, borderRadius: 10, border: `2px solid ${T.amber}`,
              background: T.amberLight, color: "#92400e", fontSize: 14, fontWeight: 700, cursor: "pointer"
            }}>âœï¸ Editar</button>
            <button onClick={() => setConfirmDelete(true)} style={{
              flex: 1, padding: 12, borderRadius: 10, border: `2px solid ${T.red}`,
              background: T.redLight, color: T.red, fontSize: 14, fontWeight: 700, cursor: "pointer"
            }}>ğŸ—‘ï¸ Eliminar</button>
          </div>
        )}

        {isAdmin && confirmDelete && (
          <div style={{ margin: "0 16px 16px", background: T.redLight, border: `2px solid ${T.red}`, borderRadius: 12, padding: 16 }}>
            <div style={{ fontSize: 14, fontWeight: 800, color: T.red, marginBottom: 6 }}>âš ï¸ Â¿Confirmar eliminaciÃ³n?</div>
            <div style={{ fontSize: 12, color: T.slate, marginBottom: 14, lineHeight: 1.5 }}>
              Este movimiento de <strong>{reg.empresa}</strong> serÃ¡ eliminado permanentemente. Esta acciÃ³n no se puede deshacer.
            </div>
            <div style={{ display: "flex", gap: 8 }}>
              <button onClick={() => setConfirmDelete(false)} style={{
                flex: 1, padding: "10px", borderRadius: 8, border: `1px solid ${T.border}`,
                background: T.white, color: T.slate, fontWeight: 700, cursor: "pointer", fontSize: 13
              }}>Cancelar</button>
              <button onClick={() => onDelete(reg.id)} style={{
                flex: 1, padding: "10px", borderRadius: 8, border: "none",
                background: T.red, color: "#fff", fontWeight: 800, cursor: "pointer", fontSize: 13
              }}>SÃ­, eliminar</button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

// â”€â”€â”€ Edit Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function EditModal({ reg, empresas, onSave, onClose }) {
  const [tipo, setTipo] = useState(reg.tipo);
  const [empresaId, setEmpresaId] = useState(reg.empresaId);
  const [busqueda, setBusqueda] = useState(reg.empresa);
  const [showList, setShowList] = useState(false);
  const empActivas = empresas.filter(e => e.activa);
  const empFilt = empActivas.filter(e => e.nombre.toLowerCase().includes(busqueda.toLowerCase()));
  const empSel = empActivas.find(e => e.id === empresaId);

  return (
    <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,.65)", zIndex: 200, display: "flex", alignItems: "center", justifyContent: "center", padding: 20 }}>
      <div className="fade-in" style={{ background: T.white, borderRadius: 18, padding: 28, width: "100%", maxWidth: 400 }}>
        <h3 style={{ fontSize: 18, fontWeight: 800, color: T.navy, marginBottom: 20 }}>
          âœï¸ Editar Registro #{String(reg.consecutivo).padStart(4, "0")}
        </h3>

        <p style={{ fontSize: 12, fontWeight: 700, color: T.slate, textTransform: "uppercase", marginBottom: 8 }}>Tipo:</p>
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8, marginBottom: 20 }}>
          {[{ v: "entrada", l: "â†‘ ENTRADA" }, { v: "salida", l: "â†“ SALIDA" }].map(o => (
            <button key={o.v} onClick={() => setTipo(o.v)} style={{
              padding: 12, borderRadius: 10, cursor: "pointer", fontWeight: 800, fontSize: 14,
              border: `2px solid ${tipo === o.v ? (o.v === "entrada" ? T.green : T.red) : T.border}`,
              background: tipo === o.v ? (o.v === "entrada" ? T.greenLight : T.redLight) : T.white,
              color: tipo === o.v ? (o.v === "entrada" ? T.green : T.red) : T.muted,
            }}>{o.l}</button>
          ))}
        </div>

        <p style={{ fontSize: 12, fontWeight: 700, color: T.slate, textTransform: "uppercase", marginBottom: 8 }}>Empresa:</p>
        <div style={{ position: "relative", marginBottom: 20 }}>
          <input value={busqueda} onChange={e => { setBusqueda(e.target.value); setEmpresaId(""); setShowList(true); }}
            onFocus={() => setShowList(true)}
            style={{ width: "100%", padding: "10px 14px", borderRadius: 8, border: `1px solid ${T.border}`, fontSize: 14 }} />
          {showList && (
            <div style={{ position: "absolute", top: "100%", left: 0, right: 0, background: T.white, border: `1px solid ${T.border}`, borderRadius: 10, maxHeight: 160, overflowY: "auto", zIndex: 10, boxShadow: "0 4px 16px rgba(0,0,0,.1)", marginTop: 4 }}>
              {empFilt.map(e => (
                <div key={e.id} onClick={() => { setEmpresaId(e.id); setBusqueda(e.nombre); setShowList(false); }}
                  style={{ padding: "10px 14px", cursor: "pointer", fontSize: 13, borderBottom: `1px solid ${T.border}`, background: empresaId === e.id ? T.bg : "" }}
                >{e.nombre}</div>
              ))}
            </div>
          )}
        </div>

        <div style={{ display: "flex", gap: 10 }}>
          <button onClick={onClose} style={{ flex: 1, padding: 12, borderRadius: 10, border: `1px solid ${T.border}`, background: T.white, cursor: "pointer", fontWeight: 600, fontSize: 14 }}>Cancelar</button>
          <button onClick={() => onSave({ ...reg, tipo, empresa: empSel?.nombre || reg.empresa, empresaId: empresaId || reg.empresaId })}
            style={{ flex: 1, padding: 12, borderRadius: 10, border: "none", background: "#7dd105", color: "#05200b", cursor: "pointer", fontWeight: 800, fontSize: 14 }}>Guardar</button>
        </div>
      </div>
    </div>
  );
}

// â”€â”€â”€ Cumplimiento de Horas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DIAS_MAP = { 0:"domingo",1:"lunes",2:"martes",3:"miÃ©rcoles",4:"jueves",5:"viernes",6:"sÃ¡bado" };

function getWeekRange(offsetWeeks = 0) {
  const now   = new Date();
  const day   = now.getDay(); // 0=dom
  const diffToMon = (day === 0 ? -6 : 1 - day);
  const mon   = new Date(now); mon.setDate(now.getDate() + diffToMon + offsetWeeks * 7);
  mon.setHours(0,0,0,0);
  const sun   = new Date(mon); sun.setDate(mon.getDate() + 6); sun.setHours(23,59,59,999);
  return { mon, sun };
}

function fmtWeekLabel(mon, sun) {
  const opts = { day: "numeric", month: "short" };
  return `${mon.toLocaleDateString("es-CO", opts)} â€“ ${sun.toLocaleDateString("es-CO", opts)}`;
}

function CumplimientoView({ acuerdos, visitas, empresas, sedes }) {
  const [weekOffset, setWeekOffset] = useState(0);
  const [filtroEmp,  setFiltroEmp]  = useState("");
  const [filtroSede, setFiltroSede] = useState("");

  const { mon, sun } = useMemo(() => getWeekRange(weekOffset), [weekOffset]);
  const isCurrentWeek = weekOffset === 0;
  const today = new Date(); today.setHours(23,59,59,999);
  const limitDay = isCurrentWeek ? today : sun; // si semana pasada, contar todos los dÃ­as

  // Horas reales por empresaId+sedeId en la semana seleccionada (solo visitas completas)
  const horasReales = useMemo(() => {
    const map = {};
    visitas
      .filter(v => v.status === "completo" && v.duracionMin !== null)
      .forEach(v => {
        const ts = new Date(v.fecha || v.entrada?.timestamp);
        if (ts >= mon && ts <= sun) {
          const k = `${v.empresaId}__${v.sedeId}`;
          map[k] = (map[k] || 0) + (v.duracionMin / 60);
        }
      });
    return map;
  }, [visitas, mon, sun]);

  // Horas acordadas hasta hoy (o hasta fin de semana si es pasada)
  const horasAcordadas = useMemo(() => {
    const map = {};
    acuerdos.forEach(a => {
      const k = `${a.empresaId}__${a.sedeId}`;
      let total = 0;
      // Iterar cada dÃ­a de la semana
      for (let i = 0; i < 7; i++) {
        const d = new Date(mon); d.setDate(mon.getDate() + i);
        if (d > limitDay) break; // no contar dÃ­as futuros
        const nombreDia = DIAS_MAP[d.getDay()];
        total += Number(a.horas?.[nombreDia] || 0);
      }
      map[k] = (map[k] || 0) + total;
    });
    return map;
  }, [acuerdos, mon, limitDay]);

  // Construir filas
  const filas = useMemo(() => {
    return acuerdos
      .filter(a => {
        if (filtroEmp  && a.empresaId !== filtroEmp)  return false;
        if (filtroSede && a.sedeId    !== filtroSede) return false;
        return true;
      })
      .map(a => {
        const k        = `${a.empresaId}__${a.sedeId}`;
        const acordado = horasAcordadas[k] || 0;
        const real     = horasReales[k]    || 0;
        const pct      = acordado > 0 ? Math.min(100, Math.round((real / acordado) * 100)) : null;
        const emp      = empresas.find(e => e.id === a.empresaId);
        const sede     = sedes.find(s => s.id === a.sedeId);
        return { key: k, emp, sede, acordado, real, pct, acuerdo: a };
      })
      .sort((a, b) => (a.pct ?? 101) - (b.pct ?? 101)); // peor cumplimiento primero
  }, [acuerdos, horasAcordadas, horasReales, empresas, sedes, filtroEmp, filtroSede]);

  // Stats globales (de las filas filtradas)
  const stats = useMemo(() => {
    const conAcuerdo = filas.filter(f => f.acordado > 0);
    const cumplidas  = conAcuerdo.filter(f => f.pct >= 100).length;
    const enRiesgo   = conAcuerdo.filter(f => f.pct < 50).length;
    const totalAcord = filas.reduce((s, f) => s + f.acordado, 0);
    const totalReal  = filas.reduce((s, f) => s + f.real, 0);
    const pctGlobal  = totalAcord > 0 ? Math.round((totalReal / totalAcord) * 100) : 0;
    return { conAcuerdo: conAcuerdo.length, cumplidas, enRiesgo, totalAcord, totalReal, pctGlobal };
  }, [filas]);

  const pctColor = (pct) => {
    if (pct === null) return T.muted;
    if (pct >= 100) return "#16a34a";
    if (pct >= 70)  return "#ca8a04";
    if (pct >= 40)  return "#ea580c";
    return "#dc2626";
  };

  const pctBg = (pct) => {
    if (pct === null) return T.bg;
    if (pct >= 100) return "#f0fdf4";
    if (pct >= 70)  return "#fefce8";
    if (pct >= 40)  return "#fff7ed";
    return "#fef2f2";
  };

  const fmt1 = (h) => Math.round(h * 10) / 10;

  return (
    <div style={{ maxWidth: 860, margin: "0 auto", paddingBottom: 40 }}>

      {/* Header + navegaciÃ³n semanas */}
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16, flexWrap: "wrap", gap: 12 }}>
        <div>
          <h2 style={{ fontSize: 20, fontWeight: 900, color: T.navy, margin: 0 }}>ğŸ“Š Cumplimiento de Horas</h2>
          <p style={{ fontSize: 13, color: T.muted, margin: "4px 0 0" }}>Horas visitadas vs acordadas por empresa y sede</p>
        </div>
        {/* Navegador de semanas */}
        <div style={{ display: "flex", alignItems: "center", gap: 8, background: T.white, border: `1px solid ${T.border}`, borderRadius: 10, padding: "6px 8px" }}>
          <button onClick={() => setWeekOffset(w => w - 1)}
            style={{ border: "none", background: "none", cursor: "pointer", padding: "4px 8px", fontSize: 16, color: T.slate, borderRadius: 6 }}>â€¹</button>
          <span style={{ fontSize: 13, fontWeight: 700, color: T.navy, minWidth: 160, textAlign: "center" }}>
            {isCurrentWeek ? "ğŸ“… Semana actual" : fmtWeekLabel(mon, sun)}
          </span>
          <button onClick={() => setWeekOffset(w => Math.min(0, w + 1))}
            style={{ border: "none", background: "none", cursor: "pointer", padding: "4px 8px", fontSize: 16, color: weekOffset === 0 ? T.border : T.slate, borderRadius: 6 }}
            disabled={weekOffset === 0}>â€º</button>
        </div>
      </div>

      {/* Filtros */}
      <div style={{ display: "flex", gap: 10, marginBottom: 16, flexWrap: "wrap" }}>
        <select value={filtroEmp} onChange={e => setFiltroEmp(e.target.value)}
          style={{ flex: 1, minWidth: 180, padding: "9px 12px", borderRadius: 8, border: `1.5px solid ${filtroEmp ? T.amber : T.border}`, fontSize: 13, background: "#fff", color: T.navy }}>
          <option value="">ğŸ­ Todas las empresas</option>
          {[...new Set(acuerdos.map(a => a.empresaId))].map(id => {
            const e = empresas.find(x => x.id === id);
            return e ? <option key={id} value={id}>{e.nombre}</option> : null;
          })}
        </select>
        <select value={filtroSede} onChange={e => setFiltroSede(e.target.value)}
          style={{ flex: 1, minWidth: 160, padding: "9px 12px", borderRadius: 8, border: `1.5px solid ${filtroSede ? T.amber : T.border}`, fontSize: 13, background: "#fff", color: T.navy }}>
          <option value="">ğŸ“ Todas las sedes</option>
          {[...new Set(acuerdos.map(a => a.sedeId))].map(id => {
            const s = sedes.find(x => x.id === id);
            return s ? <option key={id} value={id}>{s.nombre}</option> : null;
          })}
        </select>
        {(filtroEmp || filtroSede) && (
          <button onClick={() => { setFiltroEmp(""); setFiltroSede(""); }}
            style={{ padding: "9px 14px", borderRadius: 8, border: "none", background: "#ef4444", color: "#fff", fontSize: 12, fontWeight: 700, cursor: "pointer" }}>âœ• Limpiar</button>
        )}
      </div>

      {/* Stats globales */}
      <div style={{ display: "flex", gap: 10, marginBottom: 20, flexWrap: "wrap" }}>
        {[
          { label: "Cumplimiento global", value: `${stats.pctGlobal}%`, color: pctColor(stats.pctGlobal) },
          { label: "Horas reales",        value: `${fmt1(stats.totalReal)}h`,  color: "#0ea5e9" },
          { label: "Horas acordadas",     value: `${fmt1(stats.totalAcord)}h`, color: T.slate },
          { label: "Al dÃ­a âœ…",           value: stats.cumplidas,  color: "#16a34a" },
          { label: "En riesgo ğŸ”´",        value: stats.enRiesgo,   color: "#dc2626" },
        ].map(st => (
          <div key={st.label} style={{ flex: "1 1 120px", background: T.white, borderRadius: 12, padding: "12px 16px", border: `1px solid ${T.border}` }}>
            <div style={{ fontSize: 22, fontWeight: 900, color: st.color }}>{st.value}</div>
            <div style={{ fontSize: 11, color: T.muted, marginTop: 2 }}>{st.label}</div>
          </div>
        ))}
      </div>

      {/* Lista de cumplimiento */}
      {filas.length === 0 ? (
        <div style={{ background: T.white, borderRadius: 16, padding: "48px 24px", textAlign: "center", border: `1px solid ${T.border}` }}>
          <div style={{ fontSize: 40, marginBottom: 12 }}>ğŸ“Š</div>
          <div style={{ fontSize: 15, fontWeight: 700, color: T.navy }}>
            {acuerdos.length === 0 ? "No hay acuerdos registrados" : "Sin resultados con este filtro"}
          </div>
        </div>
      ) : (
        <div style={{ background: T.white, borderRadius: 14, border: `1px solid ${T.border}`, overflow: "hidden" }}>
          {/* Cabecera tabla */}
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 90px 90px 110px 80px", gap: 8, padding: "10px 16px", background: T.bg, borderBottom: `1px solid ${T.border}`, fontSize: 11, fontWeight: 700, color: T.muted, textTransform: "uppercase", letterSpacing: 0.5 }}>
            <div>Empresa</div>
            <div>Sede</div>
            <div style={{ textAlign: "right" }}>Acordado</div>
            <div style={{ textAlign: "right" }}>Real</div>
            <div style={{ textAlign: "center" }}>Progreso</div>
            <div style={{ textAlign: "center" }}>%</div>
          </div>
          {filas.map(f => (
            <div key={f.key} style={{ display: "grid", gridTemplateColumns: "1fr 1fr 90px 90px 110px 80px", gap: 8, padding: "12px 16px", borderBottom: `1px solid ${T.border}`, alignItems: "center", background: pctBg(f.pct) }}>
              <div style={{ fontSize: 13, fontWeight: 700, color: T.navy }}>{f.emp?.nombre || "â€”"}</div>
              <div style={{ fontSize: 12, color: T.muted }}>ğŸ“ {f.sede?.nombre || "â€”"}</div>
              <div style={{ textAlign: "right", fontSize: 13, color: T.slate }}>{fmt1(f.acordado)}h</div>
              <div style={{ textAlign: "right", fontSize: 13, fontWeight: 700, color: f.real > 0 ? "#0ea5e9" : T.muted }}>{fmt1(f.real)}h</div>
              {/* Barra de progreso */}
              <div style={{ position: "relative", height: 8, borderRadius: 99, background: T.border, overflow: "hidden" }}>
                <div style={{ position: "absolute", left: 0, top: 0, bottom: 0, borderRadius: 99, width: `${Math.min(100, f.pct || 0)}%`, background: pctColor(f.pct), transition: "width .4s" }} />
              </div>
              {/* Badge % */}
              <div style={{ textAlign: "center" }}>
                {f.acordado === 0 ? (
                  <span style={{ fontSize: 11, color: T.muted }}>Sin meta</span>
                ) : (
                  <span style={{ display: "inline-block", padding: "3px 10px", borderRadius: 99, fontSize: 12, fontWeight: 800, background: pctBg(f.pct), color: pctColor(f.pct), border: `1.5px solid ${pctColor(f.pct)}` }}>
                    {f.pct}%
                  </span>
                )}
              </div>
            </div>
          ))}
        </div>
      )}

      <div style={{ marginTop: 12, fontSize: 11, color: T.muted, textAlign: "center" }}>
        {isCurrentWeek
          ? `* Horas acordadas calculadas hasta hoy (${new Date().toLocaleDateString("es-CO", { weekday: "long", day: "numeric", month: "long" })})`
          : `* Semana completa: ${fmtWeekLabel(mon, sun)}`}
        {" Â· "}Solo visitas con entrada Y salida registradas cuentan como horas reales.
      </div>
    </div>
  );
}

// â”€â”€â”€ Acuerdos Comerciales â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DIAS = ["lunes","martes","miÃ©rcoles","jueves","viernes","sÃ¡bado","domingo"];
const DIAS_SHORT = ["Lun","Mar","MiÃ©","Jue","Vie","SÃ¡b","Dom"];

function AcuerdosView({ acuerdos, empresas, sedes, onUpdateAcuerdos, canEdit, topBar, showExportExterno, onCloseExportExterno }) {
  const [filtroEmpId, setFiltroEmpId]   = useState("");
  const [filtroSedeId, setFiltroSedeId] = useState("");
  const [showForm, setShowForm]         = useState(false);
  const [editando, setEditando]         = useState(null);
  const [showExport, setShowExport]     = useState(false);
  const [exportFiltro, setExportFiltro] = useState("todo");
  const [exportSedeId, setExportSedeId] = useState("");
  const [exportEmpId, setExportEmpId]   = useState("");

  // Sincronizar con el botÃ³n externo del header
  const exportVisible = showExport || showExportExterno;
  const closeExport = () => { setShowExport(false); if (onCloseExportExterno) onCloseExportExterno(); };

  const empActivas   = empresas.filter(e => e.activa);
  const sedesActivas = sedes.filter(s => s.activa);
  const totalHoras   = (h) => DIAS.reduce((s, d) => s + (Number(h?.[d]) || 0), 0);

  const acuerdosFilt = acuerdos.filter(a => {
    if (filtroEmpId  && a.empresaId !== filtroEmpId)  return false;
    if (filtroSedeId && a.sedeId    !== filtroSedeId) return false;
    return true;
  });

  const exportarAcuerdos = () => {
    const escape = v => {
      const s = String(v ?? "");
      return s.includes(",") || s.includes('"') ? `"${s.replace(/"/g, '""')}"` : s;
    };
    let datos = [...acuerdos];
    let sufijo = "Todo";
    if (exportFiltro === "sede" && exportSedeId) {
      datos = datos.filter(a => a.sedeId === exportSedeId);
      sufijo = "Sede_" + (sedes.find(s => s.id === exportSedeId)?.nombre || "");
    } else if (exportFiltro === "empresa" && exportEmpId) {
      datos = datos.filter(a => a.empresaId === exportEmpId);
      sufijo = "Empresa_" + (empresas.find(e => e.id === exportEmpId)?.nombre || "");
    }
    const headers = ["Empresa","Sede","Lun","Mar","MiÃ©","Jue","Vie","SÃ¡b","Dom","Total h/semana","Notas"];
    const rows = datos.map(a => {
      const emp  = empresas.find(e => e.id === a.empresaId);
      const sede = sedes.find(s => s.id === a.sedeId);
      return [
        emp?.nombre  || "â€”", sede?.nombre || "â€”",
        Number(a.horas?.lunes || 0),
        Number(a.horas?.martes || 0),
        Number(a.horas?.["miÃ©rcoles"] || 0),
        Number(a.horas?.jueves || 0),
        Number(a.horas?.viernes || 0),
        Number(a.horas?.["sÃ¡bado"] || 0),
        Number(a.horas?.domingo || 0),
        totalHoras(a.horas),
        a.notas || "",
      ].map(escape).join(",");
    });
    const fecha = new Date().toISOString().slice(0,10);
    const csv  = "\uFEFF" + [headers.join(","), ...rows].join("\r\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url  = URL.createObjectURL(blob);
    const el   = document.createElement("a");
    el.href = url; el.download = `Canaveral_Acuerdos_${sufijo}_${fecha}.csv`;
    document.body.appendChild(el); el.click();
    document.body.removeChild(el); URL.revokeObjectURL(url);
    closeExport();
  };

  // Resumen contextual segÃºn filtro activo
  const resumen = useMemo(() => {
    const base = acuerdosFilt;
    const hTotal = base.reduce((s, a) => s + totalHoras(a.horas), 0);
    if (filtroSedeId && !filtroEmpId) {
      // Viendo UNA sede â†’ cuÃ¡ntas empresas, cuÃ¡ntas horas
      return [
        { label: "Empresas en esta sede", value: new Set(base.map(a => a.empresaId)).size, color: "#0ea5e9" },
        { label: "Acuerdos",              value: base.length,                               color: T.amber  },
        { label: "Total horas/semana",    value: hTotal + "h",                              color: "#7dd105"},
      ];
    }
    if (filtroEmpId && !filtroSedeId) {
      // Viendo UNA empresa â†’ cuÃ¡ntas sedes, cuÃ¡ntas horas
      return [
        { label: "Sedes con acuerdo",  value: new Set(base.map(a => a.sedeId)).size, color: "#7c3aed" },
        { label: "Acuerdos",           value: base.length,                            color: T.amber   },
        { label: "Total horas/semana", value: hTotal + "h",                           color: "#7dd105" },
      ];
    }
    // Vista global
    return [
      { label: "Acuerdos activos",      value: acuerdos.length,                            color: T.amber  },
      { label: "Empresas con acuerdo",  value: new Set(acuerdos.map(a => a.empresaId)).size, color: "#0ea5e9"},
      { label: "Sedes cubiertas",       value: new Set(acuerdos.map(a => a.sedeId)).size,    color: "#7c3aed"},
      { label: "Total horas/semana",    value: acuerdos.reduce((s,a) => s + totalHoras(a.horas), 0) + "h", color: "#7dd105"},
    ];
  }, [acuerdosFilt, filtroEmpId, filtroSedeId, acuerdos]);

  const handleSave = (acuerdo) => {
    if (editando) {
      onUpdateAcuerdos(acuerdos.map(a => a.id === acuerdo.id ? acuerdo : a));
    } else {
      onUpdateAcuerdos([...acuerdos, { ...acuerdo, id: `ac-${Date.now()}` }]);
    }
    setShowForm(false); setEditando(null);
  };

  const handleDelete = (id) => {
    if (window.confirm("Â¿Eliminar este acuerdo comercial?"))
      onUpdateAcuerdos(acuerdos.filter(a => a.id !== id));
  };

  if (showForm || editando) return (
    <div style={{ flex: 1, overflowY: "auto", padding: 20 }}>
      <AcuerdoForm
        acuerdo={editando}
        empresas={empActivas}
        sedes={sedesActivas}
        onSave={handleSave}
        onCancel={() => { setShowForm(false); setEditando(null); }}
      />
    </div>
  );

  return (
    <div style={{ maxWidth: 800, margin: "0 auto", paddingBottom: 40 }}>
      {topBar}

      {/* Modal exportar */}
      {exportVisible && (
        <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,.55)", zIndex: 500, display: "flex", alignItems: "center", justifyContent: "center", padding: 20 }}
          onClick={e => e.target === e.currentTarget && closeExport()}>
          <div style={{ background: "#fff", borderRadius: 18, width: "100%", maxWidth: 440, maxHeight: "85vh", display: "flex", flexDirection: "column", boxShadow: "0 24px 64px rgba(0,0,0,.25)", overflow: "hidden" }}>
            {/* Header fijo */}
            <div style={{ background: "#05200b", padding: "18px 22px", display: "flex", justifyContent: "space-between", alignItems: "center", borderRadius: "18px 18px 0 0", flexShrink: 0 }}>
              <div style={{ color: "#fff", fontWeight: 800, fontSize: 17 }}>ğŸ“Š Exportar Acuerdos</div>
              <button onClick={closeExport} style={{ background: "rgba(255,255,255,.15)", border: "none", color: "#fff", width: 30, height: 30, borderRadius: 8, cursor: "pointer", fontWeight: 800 }}>âœ•</button>
            </div>
            {/* Contenido con scroll */}
            <div style={{ padding: 22, overflowY: "auto", flex: 1 }}>
              <p style={{ fontSize: 13, color: T.slate, marginBottom: 16 }}>Selecciona quÃ© acuerdos incluir en el Excel:</p>

              {[
                { k: "todo",    label: "ğŸŒ Toda la compaÃ±Ã­a",   desc: `${acuerdos.length} acuerdos` },
                { k: "sede",    label: "ğŸ“ Filtrar por sede",    desc: "Solo una sede" },
                { k: "empresa", label: "ğŸ­ Filtrar por empresa", desc: "Solo una empresa" },
              ].map(op => (
                <div key={op.k} onClick={() => setExportFiltro(op.k)}
                  style={{ display: "flex", alignItems: "center", gap: 12, padding: "12px 14px", borderRadius: 10, marginBottom: 8, cursor: "pointer",
                    background: exportFiltro === op.k ? T.amberLight : T.bg,
                    border: `2px solid ${exportFiltro === op.k ? T.amber : T.border}` }}>
                  <div style={{ width: 18, height: 18, borderRadius: "50%", border: `2px solid ${exportFiltro === op.k ? T.amber : T.border}`, display: "flex", alignItems: "center", justifyContent: "center", flexShrink: 0 }}>
                    {exportFiltro === op.k && <div style={{ width: 9, height: 9, borderRadius: "50%", background: T.amber }} />}
                  </div>
                  <div>
                    <div style={{ fontSize: 14, fontWeight: 700, color: T.navy }}>{op.label}</div>
                    <div style={{ fontSize: 12, color: T.muted }}>{op.desc}</div>
                  </div>
                </div>
              ))}

              {exportFiltro === "sede" && (
                <select value={exportSedeId} onChange={e => setExportSedeId(e.target.value)}
                  style={{ width: "100%", padding: "10px 12px", borderRadius: 8, border: `1.5px solid ${T.border}`, fontSize: 14, background: "#fff", color: T.navy, marginTop: 4 }}>
                  <option style={{ color: T.navy }} value="">-- Selecciona sede --</option>
                  {sedesActivas.filter(s => acuerdos.some(a => a.sedeId === s.id)).map(s => (
                    <option style={{ color: T.navy }} key={s.id} value={s.id}>{s.nombre} ({acuerdos.filter(a => a.sedeId === s.id).length} acuerdos)</option>
                  ))}
                </select>
              )}

              {exportFiltro === "empresa" && (
                <select value={exportEmpId} onChange={e => setExportEmpId(e.target.value)}
                  style={{ width: "100%", padding: "10px 12px", borderRadius: 8, border: `1.5px solid ${T.border}`, fontSize: 14, background: "#fff", color: T.navy, marginTop: 4 }}>
                  <option style={{ color: T.navy }} value="">-- Selecciona empresa --</option>
                  {empActivas.filter(e => acuerdos.some(a => a.empresaId === e.id)).map(e => (
                    <option style={{ color: T.navy }} key={e.id} value={e.id}>{e.nombre} ({acuerdos.filter(a => a.empresaId === e.id).length} sedes)</option>
                  ))}
                </select>
              )}

              <div style={{ marginTop: 12, padding: "10px 14px", background: "#f0fdf4", borderRadius: 8, fontSize: 12, color: "#166534" }}>
                ğŸ’¡ Se descarga como <strong>.csv</strong> â€” Excel lo abre directo con todas las columnas organizadas
              </div>

              <button onClick={exportarAcuerdos}
                disabled={(exportFiltro === "sede" && !exportSedeId) || (exportFiltro === "empresa" && !exportEmpId)}
                style={{ width: "100%", marginTop: 16, padding: "13px", borderRadius: 10, border: "none",
                  background: (exportFiltro === "sede" && !exportSedeId) || (exportFiltro === "empresa" && !exportEmpId) ? "#94a3b8" : "#16a34a",
                  color: "#fff", fontWeight: 800, fontSize: 15, cursor: "pointer" }}>
                ğŸ“¥ Descargar Excel
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Header */}
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16, flexWrap: "wrap", gap: 12 }}>
        <div>
          <h2 style={{ fontSize: 20, fontWeight: 900, color: T.navy, margin: 0 }}>ğŸ¤ Acuerdos Comerciales</h2>
          <p style={{ fontSize: 13, color: T.muted, margin: "4px 0 0" }}>Horas pactadas por empresa, sede y dÃ­a</p>
        </div>
        <div style={{ display: "flex", gap: 8 }}>
          <button onClick={() => setShowExport(true)} style={{
            padding: "9px 16px", borderRadius: 10, border: "none",
            background: "#16a34a", color: "#fff", fontWeight: 700, fontSize: 13, cursor: "pointer"
          }}>ğŸ“Š Excel</button>
          {canEdit && (
            <button onClick={() => { setEditando(null); setShowForm(true); }} style={{
              padding: "9px 16px", borderRadius: 10, border: "none",
              background: T.amber, color: T.navy, fontWeight: 800, fontSize: 13, cursor: "pointer"
            }}>+ Nuevo acuerdo</button>
          )}
        </div>
      </div>

      {/* Filtros */}
      <div style={{ background: T.navy, borderRadius: 14, padding: "14px 18px", marginBottom: 16, display: "flex", gap: 12, flexWrap: "wrap", alignItems: "center" }}>
        <span style={{ color: "rgba(255,255,255,.7)", fontSize: 12, fontWeight: 700, textTransform: "uppercase", letterSpacing: 1, whiteSpace: "nowrap" }}>ğŸ” Filtrar por</span>
        <select value={filtroEmpId} onChange={e => setFiltroEmpId(e.target.value)}
          style={{ flex: 1, minWidth: 180, padding: "9px 12px", borderRadius: 8, border: `2px solid ${filtroEmpId ? T.amber : "transparent"}`, fontSize: 13, background: "#ffffff", color: "#05200b", fontWeight: 400, outline: "none" }}>
          <option style={{ background: "#ffffff", color: "#05200b" }} value="">ğŸ­ Todas las empresas</option>
          {empActivas.filter(e => acuerdos.some(a => a.empresaId === e.id)).map(e => (
            <option style={{ background: "#ffffff", color: "#05200b" }} key={e.id} value={e.id}>{e.nombre}</option>
          ))}
        </select>
        <select value={filtroSedeId} onChange={e => setFiltroSedeId(e.target.value)}
          style={{ flex: 1, minWidth: 160, padding: "9px 12px", borderRadius: 8, border: `2px solid ${filtroSedeId ? T.amber : "transparent"}`, fontSize: 13, background: "#ffffff", color: "#05200b", fontWeight: 400, outline: "none" }}>
          <option style={{ background: "#ffffff", color: "#05200b" }} value="">ğŸ“ Todas las sedes</option>
          {sedesActivas.filter(s => acuerdos.some(a => a.sedeId === s.id)).map(s => (
            <option style={{ background: "#ffffff", color: "#05200b" }} key={s.id} value={s.id}>{s.nombre}</option>
          ))}
        </select>
        {(filtroEmpId || filtroSedeId) && (
          <button onClick={() => { setFiltroEmpId(""); setFiltroSedeId(""); }}
            style={{ padding: "9px 14px", borderRadius: 8, border: "none", background: "#ef4444", color: "#fff", fontSize: 12, fontWeight: 700, cursor: "pointer", whiteSpace: "nowrap" }}>
            âœ• Limpiar
          </button>
        )}
      </div>

      {/* Resumen contextual */}
      <div style={{ display: "flex", gap: 10, marginBottom: 20, flexWrap: "wrap" }}>
        {resumen.map(st => (
          <div key={st.label} style={{ flex: "1 1 120px", background: T.white, borderRadius: 12, padding: "12px 16px", border: `1px solid ${T.border}` }}>
            <div style={{ fontSize: 22, fontWeight: 900, color: st.color }}>{st.value}</div>
            <div style={{ fontSize: 11, color: T.muted, marginTop: 2 }}>{st.label}</div>
          </div>
        ))}
      </div>

      {/* Lista */}
      {acuerdosFilt.length === 0 ? (
        <div style={{ background: T.white, borderRadius: 16, padding: "48px 24px", textAlign: "center", border: `1px solid ${T.border}` }}>
          <div style={{ fontSize: 40, marginBottom: 12 }}>ğŸ¤</div>
          <div style={{ fontSize: 15, fontWeight: 700, color: T.navy, marginBottom: 8 }}>
            {acuerdos.length === 0 ? "No hay acuerdos registrados" : "Sin resultados con este filtro"}
          </div>
          <div style={{ fontSize: 13, color: T.muted }}>
            {canEdit && acuerdos.length === 0 ? 'Haz clic en "+ Nuevo acuerdo" para comenzar.' : ""}
          </div>
        </div>
      ) : (
        <div style={{ display: "flex", flexDirection: "column", gap: 12 }}>
          {acuerdosFilt.map(a => {
            const emp  = empresas.find(e => e.id === a.empresaId);
            const sede = sedes.find(s => s.id === a.sedeId);
            const total = totalHoras(a.horas || {});
            return (
              <div key={a.id} style={{ background: T.white, borderRadius: 14, border: `1px solid ${T.border}`, overflow: "hidden" }}>
                <div style={{ padding: "14px 18px", display: "flex", justifyContent: "space-between", alignItems: "center", borderBottom: `1px solid ${T.border}` }}>
                  <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
                    <div style={{ width: 40, height: 40, borderRadius: 10, background: T.amberLight, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 20 }}>ğŸ­</div>
                    <div>
                      <div style={{ fontSize: 15, fontWeight: 800, color: T.navy }}>{emp?.nombre || "â€”"}</div>
                      <div style={{ fontSize: 12, color: T.muted, marginTop: 2 }}>ğŸ“ {sede?.nombre || "â€”"}</div>
                    </div>
                  </div>
                  <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
                    <div style={{ textAlign: "right" }}>
                      <div style={{ fontSize: 18, fontWeight: 900, color: T.amber }}>{total}h</div>
                      <div style={{ fontSize: 10, color: T.muted }}>por semana</div>
                    </div>
                    {canEdit && (
                      <div style={{ display: "flex", gap: 6 }}>
                        <button onClick={() => { setEditando(a); setShowForm(true); }}
                          style={{ padding: "6px 12px", borderRadius: 8, border: "none", background: "#e0f2fe", color: "#0369a1", cursor: "pointer", fontSize: 12, fontWeight: 700 }}>âœï¸</button>
                        <button onClick={() => handleDelete(a.id)}
                          style={{ padding: "6px 10px", borderRadius: 8, border: "none", background: "#fee2e2", color: "#b91c1c", cursor: "pointer", fontSize: 12, fontWeight: 700 }}>ğŸ—‘ï¸</button>
                      </div>
                    )}
                  </div>
                </div>
                <div style={{ padding: "12px 18px", display: "flex", gap: 8, flexWrap: "wrap" }}>
                  {DIAS.map((d, i) => {
                    const h = Number(a.horas?.[d] || 0);
                    return (
                      <div key={d} style={{ textAlign: "center", minWidth: 46, opacity: h === 0 ? 0.35 : 1 }}>
                        <div style={{ fontSize: 10, color: T.muted, fontWeight: 700, marginBottom: 4 }}>{DIAS_SHORT[i]}</div>
                        <div style={{
                          width: 46, height: 46, borderRadius: 10, display: "flex", alignItems: "center", justifyContent: "center",
                          background: h > 0 ? T.amberLight : T.bg,
                          border: `2px solid ${h > 0 ? T.amber : T.border}`,
                          fontSize: 13, fontWeight: 800, color: h > 0 ? "#92400e" : T.muted
                        }}>{h > 0 ? `${h}h` : "â€”"}</div>
                      </div>
                    );
                  })}
                  {a.notas && (
                    <div style={{ width: "100%", marginTop: 8, padding: "8px 12px", background: "#f8fafc", borderRadius: 8, fontSize: 12, color: T.slate }}>
                      ğŸ“ {a.notas}
                    </div>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}

function AcuerdoForm({ acuerdo, empresas, sedes, onSave, onCancel }) {
  const [empresaId, setEmpresaId] = useState(acuerdo?.empresaId || "");
  const [sedeId, setSedeId]       = useState(acuerdo?.sedeId || "");
  const [horas, setHoras]         = useState(acuerdo?.horas || { lunes:0, martes:0, "miÃ©rcoles":0, jueves:0, viernes:0, "sÃ¡bado":0, domingo:0 });
  const [notas, setNotas]         = useState(acuerdo?.notas || "");
  const [busqEmp, setBusqEmp]     = useState("");

  const empFilt = empresas.filter(e => e.nombre.toLowerCase().includes(busqEmp.toLowerCase()));
  const total = DIAS.reduce((s, d) => s + (Number(horas[d]) || 0), 0);
  const canSave = empresaId && sedeId;

  return (
    <div style={{ maxWidth: 600, margin: "0 auto", padding: 4 }}>
      <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 24 }}>
        <button onClick={onCancel} style={{ background: T.bg, border: `1px solid ${T.border}`, borderRadius: 8, padding: "8px 14px", cursor: "pointer", fontSize: 13, fontWeight: 700 }}>â† Volver</button>
        <h3 style={{ fontSize: 18, fontWeight: 900, color: T.navy, margin: 0 }}>
          {acuerdo ? "Editar acuerdo" : "Nuevo acuerdo comercial"}
        </h3>
      </div>

      {/* Empresa */}
      <div style={{ background: T.white, borderRadius: 14, padding: 18, marginBottom: 14, border: `1px solid ${T.border}` }}>
        <label style={{ fontSize: 13, fontWeight: 700, color: T.slate, display: "block", marginBottom: 8 }}>ğŸ­ Empresa</label>
        <input value={busqEmp} onChange={e => setBusqEmp(e.target.value)}
          placeholder="Buscar empresa..."
          style={{ width: "100%", padding: "10px 12px", borderRadius: 8, border: `1px solid ${T.border}`, fontSize: 14, marginBottom: 8 }} />
        <select value={empresaId} onChange={e => setEmpresaId(e.target.value)}
          style={{ width: "100%", padding: "10px 12px", borderRadius: 8, border: `1.5px solid ${empresaId ? T.amber : T.border}`, fontSize: 14, background: "#fff" }}>
          <option value="">-- Selecciona la empresa --</option>
          {empFilt.map(e => <option key={e.id} value={e.id}>{e.nombre}</option>)}
        </select>
      </div>

      {/* Sede */}
      <div style={{ background: T.white, borderRadius: 14, padding: 18, marginBottom: 14, border: `1px solid ${T.border}` }}>
        <label style={{ fontSize: 13, fontWeight: 700, color: T.slate, display: "block", marginBottom: 8 }}>ğŸ“ Sede</label>
        <select value={sedeId} onChange={e => setSedeId(e.target.value)}
          style={{ width: "100%", padding: "10px 12px", borderRadius: 8, border: `1.5px solid ${sedeId ? T.amber : T.border}`, fontSize: 14, background: "#fff" }}>
          <option value="">-- Selecciona la sede --</option>
          {sedes.map(s => <option key={s.id} value={s.id}>{s.nombre}</option>)}
        </select>
      </div>

      {/* Horas por dÃ­a */}
      <div style={{ background: T.white, borderRadius: 14, padding: 18, marginBottom: 14, border: `1px solid ${T.border}` }}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16 }}>
          <label style={{ fontSize: 13, fontWeight: 700, color: T.slate }}>â± Horas por dÃ­a</label>
          <span style={{ fontSize: 14, fontWeight: 900, color: T.amber }}>{total}h / semana</span>
        </div>
        <div style={{ display: "flex", gap: 10, flexWrap: "wrap" }}>
          {DIAS.map((d, i) => (
            <div key={d} style={{ flex: "1 1 70px", textAlign: "center" }}>
              <div style={{ fontSize: 11, fontWeight: 700, color: T.slate, marginBottom: 6 }}>{DIAS_SHORT[i]}</div>
              <input
                type="number" min="0" max="24" step="0.5"
                value={horas[d] || ""}
                placeholder="0"
                onChange={e => setHoras({ ...horas, [d]: e.target.value === "" ? 0 : Number(e.target.value) })}
                style={{
                  width: "100%", padding: "10px 4px", textAlign: "center", borderRadius: 10,
                  border: `2px solid ${Number(horas[d]) > 0 ? T.amber : T.border}`,
                  fontSize: 16, fontWeight: 800, color: Number(horas[d]) > 0 ? "#92400e" : T.muted,
                  background: Number(horas[d]) > 0 ? T.amberLight : T.bg, outline: "none"
                }} />
            </div>
          ))}
        </div>
      </div>

      {/* Notas */}
      <div style={{ background: T.white, borderRadius: 14, padding: 18, marginBottom: 20, border: `1px solid ${T.border}` }}>
        <label style={{ fontSize: 13, fontWeight: 700, color: T.slate, display: "block", marginBottom: 8 }}>ğŸ“ Notas (opcional)</label>
        <textarea value={notas} onChange={e => setNotas(e.target.value)}
          placeholder="Ej: Mercaderista debe llegar antes de las 8am los lunes..."
          rows={3}
          style={{ width: "100%", padding: "10px 12px", borderRadius: 8, border: `1px solid ${T.border}`, fontSize: 13, resize: "vertical", fontFamily: "inherit" }} />
      </div>

      <div style={{ display: "flex", gap: 10 }}>
        <button onClick={onCancel} style={{ flex: 1, padding: "14px", borderRadius: 10, border: `1px solid ${T.border}`, background: T.white, fontSize: 14, fontWeight: 700, cursor: "pointer" }}>Cancelar</button>
        <button onClick={() => canSave && onSave({ ...acuerdo, id: acuerdo?.id, empresaId, sedeId, horas, notas, updatedAt: Date.now() })}
          disabled={!canSave}
          style={{ flex: 2, padding: "14px", borderRadius: 10, border: "none", background: canSave ? T.amber : "#334155", color: canSave ? T.navy : T.muted, fontSize: 14, fontWeight: 800, cursor: canSave ? "pointer" : "not-allowed" }}>
          {acuerdo ? "Guardar cambios" : "Crear acuerdo"} â€” {total}h/semana
        </button>
      </div>
    </div>
  );
}

// â”€â”€â”€ ViewAs Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ViewAsBar({ viewAs, setViewAs }) {
  const opts = [
    { key: "admin",     label: "ğŸ‘‘ Admin"      },
    { key: "viewer",    label: "ğŸ‘ï¸ Espectador" },
    { key: "comercial", label: "ğŸ­ Comercial"  },
    { key: "security",  label: "ğŸ›¡ï¸ Seguridad"  },
  ];
  return (
    <div style={{ background: "#1e293b", padding: "6px 16px", display: "flex", alignItems: "center", gap: 10, flexShrink: 0 }}>
      <span style={{ color: "rgba(255,255,255,.5)", fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: 1, whiteSpace: "nowrap" }}>
        ğŸ‘ï¸ Ver como:
      </span>
      <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
        {opts.map(o => (
          <button key={o.key} onClick={() => setViewAs(o.key)} style={{
            padding: "4px 12px", borderRadius: 99, border: "none", cursor: "pointer", fontSize: 12, fontWeight: 700,
            background: viewAs === o.key ? "rgba(125,209,5,.2)" : "rgba(255,255,255,.08)",
            color: viewAs === o.key ? "#7dd105" : "rgba(255,255,255,.45)",
            transition: "all .15s"
          }}>{o.label}</button>
        ))}
      </div>
      {viewAs !== "admin" && (
        <span style={{ marginLeft: "auto", fontSize: 10, color: "rgba(255,255,255,.3)", fontStyle: "italic" }}>
          Solo vista previa â€” tus datos reales no cambian
        </span>
      )}
    </div>
  );
}

// â”€â”€â”€ Admin Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function AdminDashboard({ user, registros, sedes, empresas, onEdit, onDelete, onNuevoRegistro, onLogout, onOpenPanel, isViewer = false, isComercial = false, onUpdateEmpresas, acuerdos = [], onUpdateAcuerdos, viewAs = "admin", onSetViewAs, online, pendingCount, syncing, onSync, lastSyncAt }) {
  const [filterSede, setFilterSede] = useState("");
  const [filterEmpresa, setFilterEmpresa] = useState("");
  const [filterDateFrom, setFilterDateFrom] = useState("");
  const [filterDateTo, setFilterDateTo]   = useState("");
  const [detailReg, setDetailReg] = useState(null);
  const [editReg, setEditReg] = useState(null);
  const [sidebarOpen, setSidebarOpen] = useState(true);
  const [showForm, setShowForm] = useState(false);
  const [showExportModal, setShowExportModal] = useState(false);
  const [showAcuerdosExport, setShowAcuerdosExport] = useState(false);
  const [showComercialPanel, setShowComercialPanel] = useState(false);
  const [exporting, setExporting] = useState(false);
  const [activeTab, setActiveTab] = useState("movimientos");
  const [detailVisita, setDetailVisita] = useState(null);
  const [filterTipo, setFilterTipo] = useState(""); // "entrada" | "salida" | ""
  const [filterStatus, setFilterStatus] = useState(""); // "completo" | "adentro" | "solo_salida" | ""

  const sedesEnUso = sedes.filter(s => s.activa && registros.some(r => r.sedeId === s.id));
  const empresasEnUso = empresas.filter(e => e.activa && registros.some(r => r.empresaId === e.id));

  const filtered = useMemo(() => {
    // Parse dates as LOCAL midnight to avoid UTC offset issues
    const fromTs = filterDateFrom
      ? (() => { const [y,m,d] = filterDateFrom.split("-"); return new Date(+y, +m-1, +d, 0,0,0,0).getTime(); })()
      : null;
    const toTs = filterDateTo
      ? (() => { const [y,m,d] = filterDateTo.split("-"); return new Date(+y, +m-1, +d, 23,59,59,999).getTime(); })()
      : null;
    return registros
      .filter(r => !filterSede    || r.sedeId    === filterSede)
      .filter(r => !filterEmpresa || r.empresaId === filterEmpresa)
      .filter(r => !fromTs || r.timestamp >= fromTs)
      .filter(r => !toTs   || r.timestamp <= toTs)
      .sort((a, b) => b.timestamp - a.timestamp);
  }, [registros, filterSede, filterEmpresa, filterDateFrom, filterDateTo]);

  const byDate = useMemo(() =>
    filtered
      .filter(r => !filterTipo || r.tipo === filterTipo)
      .reduce((acc, r) => {
        const d = new Date(r.timestamp).toDateString();
        (acc[d] = acc[d] || []).push(r);
        return acc;
      }, {}),
    [filtered, filterTipo]);

  // â”€â”€ Algoritmo de visitas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Agrupa por sede + empresa + dÃ­a y empareja entradas con salidas
  const visitas = useMemo(() => {
    const source = filtered;
    // Agrupar por clave: sedeId|empresaId|fecha
    const grupos = {};
    source.forEach(r => {
      const dia = new Date(r.timestamp).toDateString();
      const key = `${r.sedeId}|${r.empresaId}|${dia}`;
      if (!grupos[key]) grupos[key] = { entradas: [], salidas: [], meta: r };
      if (r.tipo === "entrada") grupos[key].entradas.push(r);
      else grupos[key].salidas.push(r);
    });

    const resultado = [];
    Object.entries(grupos).forEach(([key, g]) => {
      const entradas = [...g.entradas].sort((a, b) => a.timestamp - b.timestamp);
      const salidas  = [...g.salidas].sort((a, b) => a.timestamp - b.timestamp);
      const usedSalidas = new Set();

      // Emparejar cada entrada con la primer salida posterior
      entradas.forEach(entrada => {
        const salidaMatch = salidas.find(s => !usedSalidas.has(s.id) && s.timestamp > entrada.timestamp);
        if (salidaMatch) {
          usedSalidas.add(salidaMatch.id);
          const durMs = salidaMatch.timestamp - entrada.timestamp;
          const durMin = Math.round(durMs / 60000);
          resultado.push({
            visitId: `v-${entrada.id}`,
            empresa: entrada.empresa, empresaId: entrada.empresaId,
            sedeId: entrada.sedeId, sedeName: entrada.sedeName,
            fecha: entrada.timestamp,
            entrada, salida: salidaMatch,
            status: "completo",
            duracionMin: durMin,
          });
        } else {
          // Entrada sin salida = sigue adentro
          resultado.push({
            visitId: `v-${entrada.id}`,
            empresa: entrada.empresa, empresaId: entrada.empresaId,
            sedeId: entrada.sedeId, sedeName: entrada.sedeName,
            fecha: entrada.timestamp,
            entrada, salida: null,
            status: "adentro",
            duracionMin: null,
          });
        }
      });

      // Salidas sin entrada emparejada
      salidas.filter(s => !usedSalidas.has(s.id)).forEach(salida => {
        resultado.push({
          visitId: `v-out-${salida.id}`,
          empresa: salida.empresa, empresaId: salida.empresaId,
          sedeId: salida.sedeId, sedeName: salida.sedeName,
          fecha: salida.timestamp,
          entrada: null, salida,
          status: "solo_salida",
          duracionMin: null,
        });
      });
    });

    return resultado.sort((a, b) => b.fecha - a.fecha);
  }, [filtered]);

  const fmtDuracion = (min) => {
    if (min === null) return null;
    if (min < 60) return `${min} min`;
    const h = Math.floor(min / 60);
    const m = min % 60;
    return m > 0 ? `${h}h ${m}m` : `${h}h`;
  };

  const exportarExcel = useCallback(async (modo = "todos") => {
    setExporting(true);
    try {
      const escape = v => {
        const s = String(v ?? "");
        return s.includes(",") || s.includes('"') || s.includes("\n")
          ? `"${s.replace(/"/g, '""')}"` : s;
      };

      let headers, rows, filename;
      const fecha = new Date().toISOString().slice(0,10);
      const rangoStr = (filterDateFrom || filterDateTo)
        ? `_${filterDateFrom || "inicio"}_a_${filterDateTo || "hoy"}`
        : `_${fecha}`;

      if (modo === "visitas") {
        // Exportar visitas consolidadas
        headers = ["Empresa","Sede","Fecha","Hora Entrada","Hora Salida","DuraciÃ³n","Estado","Guardia Entrada","Guardia Salida"];
        rows = visitas.map(v => [
          v.empresa, v.sedeName,
          fmtDate(v.fecha),
          v.entrada ? fmtTime(v.entrada.timestamp) : "",
          v.salida  ? fmtTime(v.salida.timestamp)  : "",
          v.duracionMin !== null ? fmtDuracion(v.duracionMin) : "",
          v.status === "completo" ? "COMPLETA" : v.status === "adentro" ? "ADENTRO" : "SIN ENTRADA",
          v.entrada?.guardiaName || "",
          v.salida?.guardiaName  || "",
        ].map(escape).join(","));
        filename = `Canaveral_Visitas${rangoStr}.csv`;
      } else {
        const datos = modo === "filtrado"
          ? filtered
          : registros.slice().sort((a, b) => b.timestamp - a.timestamp);
        headers = ["NÂ° Registro","Fecha","Hora","Tipo","Empresa","Sede","Registrado por","GPS Latitud","GPS Longitud","ID Registro"];
        rows = datos.map(r => [
          String(r.consecutivo).padStart(4,"0"),
          fmtDate(r.timestamp), fmtTime(r.timestamp),
          r.tipo === "entrada" ? "ENTRADA" : "SALIDA",
          r.empresa, r.sedeName, r.guardiaName,
          r.gps?.lat || "", r.gps?.lng || "", r.id,
        ].map(escape).join(","));
        filename = modo === "filtrado"
          ? `Canaveral_Filtrado${rangoStr}.csv`
          : `Canaveral_Todos${rangoStr}.csv`;
      }

      const csv = "\uFEFF" + [headers.join(","), ...rows].join("\r\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      document.body.removeChild(a); URL.revokeObjectURL(url);
    } catch(e) { alert("Error al exportar: " + e.message); }
    setExporting(false);
    setShowExportModal(false);
  }, [filtered, registros, visitas, fmtDuracion]);

  if (showForm && !isViewer) return (
    <NuevoRegistroForm user={user} sedes={sedes} empresas={empresas} registros={registros}
      onSave={async (d) => { await onNuevoRegistro(d); setShowForm(false); }}
      onCancel={() => setShowForm(false)} />
  );

  return (
    <div style={{ height: "100vh", display: "flex", flexDirection: "column", fontFamily: "'Plus Jakarta Sans',sans-serif", background: T.bg }}>
      <OfflineBanner online={online} pending={pendingCount} onSync={onSync} syncing={syncing} />
      {showComercialPanel && (
        <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,.5)", zIndex: 999, display: "flex", alignItems: "flex-end", justifyContent: "center" }}>
          <div style={{ background: T.white, borderRadius: "20px 20px 0 0", width: "100%", maxWidth: 520, maxHeight: "85vh", overflow: "hidden", display: "flex", flexDirection: "column" }}>
            <div style={{ background: "#0ea5e9", padding: "16px 20px", display: "flex", justifyContent: "space-between", alignItems: "center" }}>
              <div style={{ color: "#fff", fontWeight: 800, fontSize: 16 }}>ğŸ­ GestiÃ³n de Empresas</div>
              <button onClick={() => setShowComercialPanel(false)} style={{ background: "rgba(255,255,255,.2)", border: "none", color: "#fff", width: 32, height: 32, borderRadius: 8, cursor: "pointer", fontSize: 16, fontWeight: 700 }}>âœ•</button>
            </div>
            <div style={{ padding: 20, overflowY: "auto", flex: 1 }}>
              <ComercialEmpresasPanel empresas={empresas} onUpdateEmpresas={onUpdateEmpresas} />
            </div>
          </div>
        </div>
      )}
      {/* Top bar */}
      <div style={{ background: T.navy, padding: "10px 16px", display: "flex", justifyContent: "space-between", alignItems: "center", flexShrink: 0, gap: 10 }}>
        <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
          <button onClick={() => setSidebarOpen(!sidebarOpen)} style={{ background: "rgba(255,255,255,.1)", border: "none", color: "#fff", width: 32, height: 32, borderRadius: 8, cursor: "pointer", fontSize: 14 }}>â˜°</button>
          <img src={LOGO_SRC} alt="CaÃ±averal" style={{ height: 30, width: 30, borderRadius: "50%", objectFit: "cover", border: "2px solid rgba(255,255,255,.2)" }} />
          <div>
            <div style={{ color: "#fff", fontSize: 14, fontWeight: 800 }}>Control de Mercaderistas</div>
            <div style={{ color: T.muted, fontSize: 11, display: "flex", alignItems: "center", gap: 6 }}>
              {isViewer ? <><span style={{ background: "#7c3aed", color: "#fff", borderRadius: 99, padding: "1px 6px", fontSize: 9, fontWeight: 800 }}>ğŸ‘ï¸ ESPECTADOR</span> {user.nombre}</>
               : isComercial ? <><span style={{ background: "#0ea5e9", color: "#fff", borderRadius: 99, padding: "1px 6px", fontSize: 9, fontWeight: 800 }}>ğŸ­ COMERCIAL</span> {user.nombre}</>
               : <>ğŸ‘‘ {user.nombre}</>}
              {" Â· "}
              <span style={{ display:"flex", alignItems:"center", gap:3 }}>
                <span style={{ width:6, height:6, borderRadius:"50%", background: online ? "#7dd105" : "#ef4444", display:"inline-block" }}/>
                <span>{online ? "En lÃ­nea" : "Offline"}</span>
              </span>
            </div>
          </div>
          {/* ViewAs inline â€” solo admin */}
          {onSetViewAs && (
            <div style={{ display: "flex", alignItems: "center", gap: 6, marginLeft: 8, paddingLeft: 12, borderLeft: "1px solid rgba(255,255,255,.15)" }}>
              <span style={{ color: "rgba(255,255,255,.4)", fontSize: 10, fontWeight: 700 }}>VER COMO</span>
              {[["admin","ğŸ‘‘"],["viewer","ğŸ‘ï¸"],["comercial","ğŸ­"],["security","ğŸ›¡ï¸"]].map(([k,ic]) => (
                <button key={k} onClick={() => onSetViewAs(k)} style={{
                  padding: "3px 10px", borderRadius: 99, border: "none", cursor: "pointer", fontSize: 11, fontWeight: 700,
                  background: viewAs === k ? "rgba(125,209,5,.25)" : "rgba(255,255,255,.07)",
                  color: viewAs === k ? "#7dd105" : "rgba(255,255,255,.4)",
                }}>{ic} {k.charAt(0).toUpperCase()+k.slice(1)}</button>
              ))}
            </div>
          )}
        </div>
        <div style={{ display: "flex", gap: 6 }}>
          {!isViewer && !isComercial && (
            <button onClick={() => setShowForm(true)} style={{
              background: T.brand, border: "none", color: T.navy, padding: "7px 14px", borderRadius: 8,
              cursor: "pointer", fontWeight: 800, fontSize: 12, display: "flex", alignItems: "center", gap: 5
            }}>+ Nuevo Registro</button>
          )}
          <button onClick={() => activeTab === "acuerdos" ? setShowAcuerdosExport(true) : setShowExportModal(true)} style={{
            background: "#16a34a", border: "none", color: "#fff",
            padding: "7px 14px", borderRadius: 8, cursor: "pointer", fontWeight: 700, fontSize: 12,
            display: "flex", alignItems: "center", gap: 5
          }}>ğŸ“Š Excel</button>
          {isComercial && (
            <button onClick={() => setShowComercialPanel(true)} style={{ background: "#0ea5e9", border: "none", color: "#fff", padding: "7px 14px", borderRadius: 8, cursor: "pointer", fontWeight: 700, fontSize: 12 }}>ğŸ­ Empresas</button>
          )}
          {!isViewer && !isComercial && (
            <button onClick={onOpenPanel} style={{ background: "rgba(255,255,255,.1)", border: "none", color: "#fff", padding: "7px 14px", borderRadius: 8, cursor: "pointer", fontWeight: 700, fontSize: 12 }}>âš™ï¸ Admin</button>
          )}
          <button onClick={onLogout} style={{ background: "rgba(255,255,255,.1)", border: "none", color: T.muted, padding: "7px 12px", borderRadius: 8, cursor: "pointer", fontSize: 12 }}>Salir</button>
        </div>
      </div>

      <div style={{ display: "flex", flex: 1, overflow: "hidden" }}>
        {/* Sidebar â€” oculto en tab Acuerdos y Cumplimiento */}
        {sidebarOpen && activeTab !== "acuerdos" && activeTab !== "cumplimiento" && (
          <div style={{ width: 260, background: T.white, borderRight: `1px solid ${T.border}`, padding: 20, overflowY: "auto", flexShrink: 0 }}>
            <div style={{ background: "#05200b", borderRadius: 12, padding: 16, marginBottom: 20, color: "#fff" }}>
              <div style={{ fontSize: 11, color: T.muted, textTransform: "uppercase", letterSpacing: 1, marginBottom: 4 }}>
                {activeTab === "visitas" ? "Visitas filtradas" : "Registros filtrados"}
              </div>
              <div style={{ fontSize: 40, fontWeight: 900, fontFamily: "'JetBrains Mono',monospace" }}>
                {activeTab === "visitas" ? visitas.length : filtered.length}
              </div>
              {activeTab === "movimientos" ? (
                <div style={{ display: "flex", gap: 16, marginTop: 8 }}>
                  <div><span style={{ fontWeight: 800, color: "#6ee7b7" }}>{filtered.filter(r => r.tipo === "entrada").length}</span><span style={{ fontSize: 11, color: T.muted }}> ent.</span></div>
                  <div><span style={{ fontWeight: 800, color: "#fca5a5" }}>{filtered.filter(r => r.tipo === "salida").length}</span><span style={{ fontSize: 11, color: T.muted }}> sal.</span></div>
                </div>
              ) : (
                <div style={{ display: "flex", gap: 10, marginTop: 8, flexWrap: "wrap" }}>
                  <div><span style={{ fontWeight: 800, color: "#6ee7b7" }}>{visitas.filter(v => v.status === "completo").length}</span><span style={{ fontSize: 11, color: T.muted }}> completas</span></div>
                  <div><span style={{ fontWeight: 800, color: T.amber }}>{visitas.filter(v => v.status === "adentro").length}</span><span style={{ fontSize: 11, color: T.muted }}> adentro</span></div>
                </div>
              )}
            </div>

            <p style={{ fontSize: 11, fontWeight: 700, color: T.muted, textTransform: "uppercase", letterSpacing: 1, marginBottom: 8 }}>Filtrar por sede</p>
            <select value={filterSede} onChange={e => setFilterSede(e.target.value)}
              style={{ width: "100%", padding: "10px 12px", borderRadius: 8, border: `1px solid ${T.border}`, fontSize: 13, marginBottom: 16, background: T.bg }}>
              <option value="">Todas las sedes ({sedesEnUso.length})</option>
              {sedesEnUso.map(s => (
                <option key={s.id} value={s.id}>{s.nombre} ({registros.filter(r => r.sedeId === s.id).length})</option>
              ))}
            </select>

            <p style={{ fontSize: 11, fontWeight: 700, color: T.muted, textTransform: "uppercase", letterSpacing: 1, marginBottom: 8 }}>Filtrar por empresa</p>
            <select value={filterEmpresa} onChange={e => setFilterEmpresa(e.target.value)}
              style={{ width: "100%", padding: "10px 12px", borderRadius: 8, border: `1px solid ${T.border}`, fontSize: 13, marginBottom: 16, background: T.bg }}>
              <option value="">Todas las empresas</option>
              {empresasEnUso.map(e => (
                <option key={e.id} value={e.id}>{e.nombre} ({registros.filter(r => r.empresaId === e.id).length})</option>
              ))}
            </select>

            {/* â”€â”€ FECHA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
            <p style={{ fontSize: 11, fontWeight: 700, color: T.muted, textTransform: "uppercase", letterSpacing: 1, marginBottom: 8 }}>Filtrar por fecha</p>
            {/* Atajos rÃ¡pidos */}
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 6, marginBottom: 10 }}>
              {[
                { label: "Hoy", fn: () => {
                  const d = new Date().toISOString().slice(0,10);
                  setFilterDateFrom(d); setFilterDateTo(d);
                }},
                { label: "Ayer", fn: () => {
                  const d = new Date(Date.now()-86400000).toISOString().slice(0,10);
                  setFilterDateFrom(d); setFilterDateTo(d);
                }},
                { label: "Esta semana", fn: () => {
                  const now=new Date(),day=now.getDay()||7,mon=new Date(now);
                  mon.setDate(now.getDate()-day+1);
                  const toLocal=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                  setFilterDateFrom(toLocal(mon)); setFilterDateTo(toLocal(now));
                }},
                { label: "Este mes", fn: () => {
                  const now=new Date(),first=new Date(now.getFullYear(),now.getMonth(),1);
                  const toLocal=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                  setFilterDateFrom(toLocal(first)); setFilterDateTo(toLocal(now));
                }},
              ].map(({ label, fn }) => {
                const isActive = (() => {
                  if (!filterDateFrom && !filterDateTo) return false;
                  if (label === "Hoy") {
                    const n=new Date(),d=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`;
                    return filterDateFrom === d && filterDateTo === d;
                  }
                  if (label === "Ayer") {
                    const y=new Date(Date.now()-86400000),d=`${y.getFullYear()}-${String(y.getMonth()+1).padStart(2,'0')}-${String(y.getDate()).padStart(2,'0')}`;
                    return filterDateFrom === d && filterDateTo === d;
                  }
                  return false;
                })();
                return (
                  <button key={label} onClick={fn} style={{
                    padding: "7px 6px", borderRadius: 8, border: `1px solid ${isActive ? T.brand : T.border}`,
                    background: isActive ? T.brandLight : T.white,
                    color: isActive ? T.brand : T.slate,
                    fontSize: 12, fontWeight: isActive ? 800 : 500, cursor: "pointer"
                  }}>{label}</button>
                );
              })}
            </div>
            {/* Rango personalizado */}
            <div style={{ display: "flex", flexDirection: "column", gap: 6, marginBottom: 6 }}>
              <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                <span style={{ fontSize: 11, color: T.muted, width: 30 }}>Desde</span>
                <input type="date" value={filterDateFrom} onChange={e => setFilterDateFrom(e.target.value)}
                  style={{ flex: 1, padding: "7px 8px", borderRadius: 8, border: `1px solid ${filterDateFrom ? T.brand : T.border}`, fontSize: 12, background: T.white }} />
              </div>
              <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                <span style={{ fontSize: 11, color: T.muted, width: 30 }}>Hasta</span>
                <input type="date" value={filterDateTo} onChange={e => setFilterDateTo(e.target.value)}
                  style={{ flex: 1, padding: "7px 8px", borderRadius: 8, border: `1px solid ${filterDateTo ? T.brand : T.border}`, fontSize: 12, background: T.white }} />
              </div>
            </div>

            {(filterSede || filterEmpresa || filterDateFrom || filterDateTo) && (
              <button onClick={() => { setFilterSede(""); setFilterEmpresa(""); setFilterDateFrom(""); setFilterDateTo(""); }}
                style={{ width: "100%", padding: "8px", borderRadius: 8, border: `1px solid ${T.border}`, background: T.white, cursor: "pointer", fontSize: 12, color: T.slate, fontWeight: 600, marginTop: 10 }}>
                âœ• Limpiar todos los filtros
              </button>
            )}

            {/* Hoy stats */}
            <div style={{ marginTop: 20, padding: "14px", background: T.bg, borderRadius: 10 }}>
              <div style={{ fontSize: 11, fontWeight: 700, color: T.muted, textTransform: "uppercase", letterSpacing: 1, marginBottom: 8 }}>Hoy</div>
              {(() => {
                const hoy = filtered.filter(r => new Date(r.timestamp).toDateString() === new Date().toDateString());
                return <div style={{ fontSize: 22, fontWeight: 900, color: T.navyMid }}>{hoy.length} <span style={{ fontSize: 12, fontWeight: 500, color: T.muted }}>movimientos</span></div>;
              })()}
            </div>
          </div>
        )}

        {/* Tab switcher + Movement/Visitas list */}
        <div style={{ flex: 1, overflowY: "auto", display: "flex", flexDirection: "column" }}>

          {/* Tabs */}
          <div style={{ background: T.white, borderBottom: `1px solid ${T.border}`, flexShrink: 0 }}>
            {/* Tab buttons */}
            <div style={{ display: "flex", padding: "0 20px", overflowX: "auto" }}>
              {[
                ["movimientos", "ğŸ“‹ Movimientos", filtered.filter(r => !filterTipo || r.tipo === filterTipo).length],
                ["visitas",     "ğŸ”„ Visitas",     visitas.filter(v => !filterStatus || v.status === filterStatus).length],
                ["acuerdos",    "ğŸ¤ Acuerdos",    acuerdos.length],
                ["cumplimiento","ğŸ“Š Cumplimiento", ""],
              ].map(([t, l, c]) => (
                <button key={t} onClick={() => setActiveTab(t)} style={{
                  padding: "13px 20px", border: "none", background: "none", cursor: "pointer",
                  fontWeight: activeTab === t ? 800 : 500, fontSize: 14,
                  color: activeTab === t ? T.navy : T.slate,
                  borderBottom: `3px solid ${activeTab === t ? T.brand : "transparent"}`,
                  display: "flex", alignItems: "center", gap: 8
                }}>
                  {l}
                  <span style={{
                    background: activeTab === t ? T.brandLight : T.bg,
                    color: activeTab === t ? "#92400e" : T.slate,
                    borderRadius: 99, padding: "1px 8px", fontSize: 11, fontWeight: 700
                  }}>{c}</span>
                </button>
              ))}
            </div>

            {/* Quick filter chips â€” Movimientos */}
            {activeTab === "movimientos" && (
              <div style={{ padding: "8px 20px 12px", display: "flex", gap: 8, flexWrap: "wrap" }}>
                {[
                  { v: "",        label: "ğŸ”µ Todos",    bg: T.navyMid,    col: "#fff",    activeBg: T.navyMid },
                  { v: "entrada", label: "â†‘ Entradas",  bg: T.greenLight, col: T.green,   activeBg: T.green },
                  { v: "salida",  label: "â†“ Salidas",   bg: T.redLight,   col: T.red,     activeBg: T.red },
                ].map(chip => {
                  const count = chip.v === ""
                    ? filtered.length
                    : filtered.filter(r => r.tipo === chip.v).length;
                  const active = filterTipo === chip.v;
                  return (
                    <button key={chip.v} onClick={() => setFilterTipo(chip.v)} style={{
                      padding: "5px 14px", borderRadius: 99, border: "none", cursor: "pointer",
                      fontWeight: 700, fontSize: 12, display: "flex", alignItems: "center", gap: 5,
                      background: active ? chip.activeBg : chip.bg,
                      color: active && chip.v !== "" ? "#fff" : active && chip.v === "" ? "#fff" : chip.col,
                      boxShadow: active ? "0 2px 8px rgba(0,0,0,.15)" : "none",
                      transition: "all .15s"
                    }}>
                      {chip.label}
                      <span style={{
                        background: active ? "rgba(255,255,255,.25)" : "rgba(0,0,0,.08)",
                        borderRadius: 99, padding: "1px 6px", fontSize: 11
                      }}>{count}</span>
                    </button>
                  );
                })}
              </div>
            )}

            {/* Quick filter chips â€” Visitas */}
            {activeTab === "visitas" && (
              <div style={{ padding: "8px 20px 12px", display: "flex", gap: 8, flexWrap: "wrap" }}>
                {[
                  { v: "",            label: "ğŸ”µ Todas",       bg: T.navyMid,   col: "#fff",     activeBg: T.navyMid },
                  { v: "completo",    label: "âœ… Completas",   bg: T.greenLight, col: T.green,   activeBg: T.green },
                  { v: "adentro",     label: "ğŸŸ¡ Adentro",     bg: T.amberLight, col: "#92400e", activeBg: "#d97706" },
                  { v: "solo_salida", label: "âš ï¸ Sin entrada", bg: T.redLight,   col: T.red,     activeBg: T.red },
                ].map(chip => {
                  const count = chip.v === ""
                    ? visitas.length
                    : visitas.filter(v => v.status === chip.v).length;
                  const active = filterStatus === chip.v;
                  return (
                    <button key={chip.v} onClick={() => setFilterStatus(chip.v)} style={{
                      padding: "5px 14px", borderRadius: 99, border: "none", cursor: "pointer",
                      fontWeight: 700, fontSize: 12, display: "flex", alignItems: "center", gap: 5,
                      background: active ? chip.activeBg : chip.bg,
                      color: active ? "#fff" : chip.col,
                      boxShadow: active ? "0 2px 8px rgba(0,0,0,.15)" : "none",
                      transition: "all .15s",
                      opacity: count === 0 ? 0.4 : 1
                    }}>
                      {chip.label}
                      <span style={{
                        background: active ? "rgba(255,255,255,.25)" : "rgba(0,0,0,.08)",
                        borderRadius: 99, padding: "1px 6px", fontSize: 11
                      }}>{count}</span>
                    </button>
                  );
                })}
              </div>
            )}
          </div>

          <div style={{ flex: 1, overflowY: "auto", padding: 20 }}>

            {/* â”€â”€ MOVIMIENTOS TAB â”€â”€ */}
            {activeTab === "movimientos" && (<>
              {Object.keys(byDate).length === 0 && (
                <div style={{ textAlign: "center", padding: "64px 20px", color: T.muted }}>
                  <div style={{ fontSize: 56 }}>ğŸ“‹</div>
                  <div style={{ fontSize: 16, fontWeight: 600, marginTop: 8 }}>Sin movimientos{filterSede || filterEmpresa ? " con estos filtros" : ""}</div>
                  <div style={{ fontSize: 13, marginTop: 4 }}>Los registros aparecerÃ¡n aquÃ­ en tiempo real</div>
                </div>
              )}
              {Object.entries(byDate).map(([dateStr, regs]) => (
                <div key={dateStr} style={{ marginBottom: 28 }}>
                  <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 12 }}>
                    <div style={{ height: 1, flex: 1, background: T.border }} />
                    <div style={{ fontSize: 12, fontWeight: 700, color: T.slate, textTransform: "capitalize", padding: "4px 12px", background: T.white, borderRadius: 99, border: `1px solid ${T.border}` }}>
                      {fmtDateLong(new Date(dateStr))}
                    </div>
                    <span style={{ background: T.navyMid, color: "#fff", borderRadius: 99, padding: "2px 8px", fontSize: 11, fontWeight: 700 }}>{regs.length}</span>
                    <div style={{ height: 1, flex: 1, background: T.border }} />
                  </div>
                  {regs.map(r => (
                    <div key={r.id} onClick={() => setDetailReg(r)} style={{
                      background: T.white, borderRadius: 12, padding: "14px 16px", marginBottom: 8,
                      display: "flex", justifyContent: "space-between", alignItems: "center",
                      cursor: "pointer", boxShadow: "0 1px 4px rgba(0,0,0,.04)",
                      borderLeft: `4px solid ${r.tipo === "entrada" ? T.green : T.red}`,
                      transition: "transform .1s, box-shadow .1s"
                    }}
                      onMouseEnter={e => { e.currentTarget.style.transform = "translateY(-1px)"; e.currentTarget.style.boxShadow = "0 4px 12px rgba(0,0,0,.1)"; }}
                      onMouseLeave={e => { e.currentTarget.style.transform = ""; e.currentTarget.style.boxShadow = "0 1px 4px rgba(0,0,0,.04)"; }}
                    >
                      <div>
                        <div style={{ fontSize: 15, fontWeight: 700, color: T.navyMid }}>{r.empresa}</div>
                        <div style={{ fontSize: 12, color: T.muted, marginTop: 3 }}>
                          <span style={{ fontFamily: "'JetBrains Mono',monospace" }}>#{String(r.consecutivo).padStart(4, "0")}</span>
                          {" Â· "}{r.sedeName}{" Â· "}{fmtTime(r.timestamp)}
                        </div>
                      </div>
                      <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                        <Badge tipo={r.tipo} />
                        {r.pendingSync && (
                          <span style={{ background:"#05200b", color:"#7dd105", borderRadius:99, padding:"2px 7px", fontSize:10, fontWeight:800 }}>â³ Pendiente</span>
                        )}
                        <span style={{ color: T.muted, fontSize: 20 }}>â€º</span>
                      </div>
                    </div>
                  ))}
                </div>
              ))}
            </>)}

            {/* â”€â”€ VISITAS TAB â”€â”€ */}
            {activeTab === "visitas" && (<>
              {visitas.filter(v => !filterStatus || v.status === filterStatus).length === 0 && (
                <div style={{ textAlign: "center", padding: "64px 20px", color: T.muted }}>
                  <div style={{ fontSize: 56 }}>ğŸ”„</div>
                  <div style={{ fontSize: 16, fontWeight: 600, marginTop: 8 }}>Sin visitas{filterStatus ? " con este filtro" : " registradas"}</div>
                  <div style={{ fontSize: 13, marginTop: 4 }}>Las visitas se calculan automÃ¡ticamente al registrar entradas y salidas</div>
                </div>
              )}
              {(() => {
                const visitasFiltradas = visitas.filter(v => !filterStatus || v.status === filterStatus);
                const byDateV = visitasFiltradas.reduce((acc, v) => {
                  const d = new Date(v.fecha).toDateString();
                  (acc[d] = acc[d] || []).push(v);
                  return acc;
                }, {});
                return Object.entries(byDateV).map(([dateStr, vList]) => (
                  <div key={dateStr} style={{ marginBottom: 28 }}>
                    <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 12 }}>
                      <div style={{ height: 1, flex: 1, background: T.border }} />
                      <div style={{ fontSize: 12, fontWeight: 700, color: T.slate, textTransform: "capitalize", padding: "4px 12px", background: T.white, borderRadius: 99, border: `1px solid ${T.border}` }}>
                        {fmtDateLong(new Date(dateStr))}
                      </div>
                      <span style={{ background: T.navyMid, color: "#fff", borderRadius: 99, padding: "2px 8px", fontSize: 11, fontWeight: 700 }}>{vList.length}</span>
                      <div style={{ height: 1, flex: 1, background: T.border }} />
                    </div>
                    {vList.map(v => {
                      const statusCfg = {
                        completo:    { bg: T.greenLight,  border: T.green,    icon: "âœ…", label: "Completa",      col: T.green },
                        adentro:     { bg: T.amberLight,  border: T.amber,    icon: "ğŸŸ¡", label: "Adentro",       col: "#92400e" },
                        solo_salida: { bg: T.redLight,    border: T.red,      icon: "âš ï¸", label: "Sin entrada",   col: T.red },
                      }[v.status];
                      return (
                        <div key={v.visitId} onClick={() => setDetailVisita(v)} style={{
                          background: T.white, borderRadius: 12, padding: "14px 16px", marginBottom: 8,
                          cursor: "pointer", boxShadow: "0 1px 4px rgba(0,0,0,.04)",
                          border: `1px solid ${T.border}`,
                          borderLeft: `4px solid ${statusCfg.border}`,
                          transition: "transform .1s, box-shadow .1s"
                        }}
                          onMouseEnter={e => { e.currentTarget.style.transform = "translateY(-1px)"; e.currentTarget.style.boxShadow = "0 4px 12px rgba(0,0,0,.1)"; }}
                          onMouseLeave={e => { e.currentTarget.style.transform = ""; e.currentTarget.style.boxShadow = "0 1px 4px rgba(0,0,0,.04)"; }}
                        >
                          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
                            <div style={{ flex: 1 }}>
                              <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 6 }}>
                                <span style={{ fontSize: 16, fontWeight: 800, color: T.navyMid }}>{v.empresa}</span>
                                <span style={{ background: statusCfg.bg, color: statusCfg.col, borderRadius: 99, padding: "2px 10px", fontSize: 11, fontWeight: 700 }}>
                                  {statusCfg.icon} {statusCfg.label}
                                </span>
                              </div>
                              <div style={{ display: "flex", gap: 16, fontSize: 12, color: T.muted }}>
                                <span>ğŸ“ {v.sedeName}</span>
                                {v.entrada && <span>â†‘ Entrada: <strong style={{ color: T.navyMid }}>{fmtTime(v.entrada.timestamp)}</strong></span>}
                                {v.salida  && <span>â†“ Salida: <strong style={{ color: T.navyMid }}>{fmtTime(v.salida.timestamp)}</strong></span>}
                              </div>
                            </div>
                            <div style={{ textAlign: "right", marginLeft: 12 }}>
                              {v.duracionMin !== null ? (
                                <div>
                                  <div style={{ fontSize: 20, fontWeight: 900, color: T.navy, fontFamily: "'JetBrains Mono',monospace" }}>{fmtDuracion(v.duracionMin)}</div>
                                  <div style={{ fontSize: 11, color: T.muted }}>tiempo en sede</div>
                                </div>
                              ) : v.status === "adentro" ? (
                                <div>
                                  <div className="pulse-dot" style={{ margin: "0 auto 4px" }} />
                                  <div style={{ fontSize: 11, color: T.muted }}>En curso</div>
                                </div>
                              ) : (
                                <span style={{ fontSize: 11, color: T.muted }}>â€”</span>
                              )}
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                ));
              })()}
            </>)}

            {/* â”€â”€ ACUERDOS TAB â”€â”€ */}
            {activeTab === "acuerdos" && (
              <AcuerdosView
                acuerdos={acuerdos}
                empresas={empresas}
                sedes={sedes}
                onUpdateAcuerdos={onUpdateAcuerdos}
                canEdit={!isViewer}
                showExportExterno={showAcuerdosExport}
                onCloseExportExterno={() => setShowAcuerdosExport(false)}
              />
            )}

            {/* â”€â”€ CUMPLIMIENTO TAB â”€â”€ */}
            {activeTab === "cumplimiento" && (
              <CumplimientoView
                acuerdos={acuerdos}
                visitas={visitas}
                empresas={empresas}
                sedes={sedes}
              />
            )}

          </div>
        </div>
      </div>

      {detailReg && (
        <DetailModal reg={detailReg} onClose={() => setDetailReg(null)}
          onEdit={r => { setEditReg(r); setDetailReg(null); }}
          onDelete={async id => { await onDelete(id); setDetailReg(null); }}
          isAdmin={!isViewer} />
      )}
      {editReg && (
        <EditModal reg={editReg} empresas={empresas}
          onSave={async u => { await onEdit(u); setEditReg(null); }}
          onClose={() => setEditReg(null)} />
      )}

      {/* â”€â”€ DETALLE VISITA MODAL â”€â”€ */}
      {detailVisita && (
        <div style={{ position:"fixed", inset:0, background:"rgba(0,0,0,.55)", zIndex:100, display:"flex", alignItems:"center", justifyContent:"center", padding:20 }}
          onClick={e => e.target===e.currentTarget && setDetailVisita(null)}>
          <div className="fade-in" style={{ background:T.white, borderRadius:18, width:"100%", maxWidth:460, maxHeight:"90vh", overflowY:"auto", boxShadow:"0 24px 64px rgba(0,0,0,.25)" }}>
            {(() => {
              const v = detailVisita;
              const statusCfg = {
                completo:    { bg: T.greenLight,  col: T.green,    icon: "âœ…", label: "Visita completa" },
                adentro:     { bg: T.amberLight,  col: "#92400e",  icon: "ğŸŸ¡", label: "AÃºn adentro" },
                solo_salida: { bg: T.redLight,    col: T.red,      icon: "âš ï¸", label: "Sin entrada registrada" },
              }[v.status];
              return (<>
                <div style={{ padding:"20px 20px 0", display:"flex", justifyContent:"space-between", alignItems:"center" }}>
                  <span style={{ fontSize:12, fontWeight:700, color:T.muted, textTransform:"uppercase", letterSpacing:1 }}>Detalle de visita</span>
                  <button onClick={() => setDetailVisita(null)} style={{ background:T.bg, border:"none", width:32, height:32, borderRadius:8, cursor:"pointer", fontSize:18, color:T.slate }}>Ã—</button>
                </div>
                <div style={{ padding:"16px 20px 20px", textAlign:"center", borderBottom:`1px solid ${T.border}` }}>
                  <span style={{ background:statusCfg.bg, color:statusCfg.col, borderRadius:99, padding:"5px 16px", fontSize:13, fontWeight:800 }}>
                    {statusCfg.icon} {statusCfg.label}
                  </span>
                  <div style={{ fontSize:24, fontWeight:900, color:T.navy, marginTop:10 }}>{v.empresa}</div>
                  <div style={{ fontSize:13, color:T.muted, marginTop:4 }}>ğŸ“ {v.sedeName}</div>
                  {v.duracionMin !== null && (
                    <div style={{ marginTop:12, display:"inline-flex", alignItems:"center", gap:8, background:T.navy, borderRadius:12, padding:"8px 20px" }}>
                      <span style={{ fontSize:28, fontWeight:900, color:"#fff", fontFamily:"'JetBrains Mono',monospace" }}>{fmtDuracion(v.duracionMin)}</span>
                      <span style={{ fontSize:12, color:T.muted }}>en sede</span>
                    </div>
                  )}
                  {v.status === "adentro" && (
                    <div style={{ marginTop:12, display:"inline-flex", alignItems:"center", gap:8, background:T.amberLight, borderRadius:12, padding:"8px 20px" }}>
                      <div className="pulse-dot" />
                      <span style={{ fontSize:13, fontWeight:700, color:"#92400e" }}>Actualmente en la sede</span>
                    </div>
                  )}
                </div>

                {/* Entrada */}
                {v.entrada && (<>
                  <div style={{ padding:"10px 16px 4px", fontSize:11, fontWeight:700, color:T.green, textTransform:"uppercase", letterSpacing:1 }}>â†‘ Registro de Entrada</div>
                  <InfoRow label="Fecha" value={fmtDate(v.entrada.timestamp)} />
                  <InfoRow label="Hora entrada" value={fmtTime(v.entrada.timestamp)} />
                  <InfoRow label="Guardia" value={v.entrada.guardiaName} />
                  <InfoRow label="GPS" value={v.entrada.gps ? `${v.entrada.gps.lat}, ${v.entrada.gps.lng}` : "No disponible"} />
                  <InfoRow label="NÂ° Registro" value={`#${String(v.entrada.consecutivo).padStart(4,"0")}`} />
                </>)}

                {/* Salida */}
                {v.salida && (<>
                  <div style={{ padding:"10px 16px 4px", fontSize:11, fontWeight:700, color:T.red, textTransform:"uppercase", letterSpacing:1 }}>â†“ Registro de Salida</div>
                  <InfoRow label="Fecha" value={fmtDate(v.salida.timestamp)} />
                  <InfoRow label="Hora salida" value={fmtTime(v.salida.timestamp)} />
                  <InfoRow label="Guardia" value={v.salida.guardiaName} />
                  <InfoRow label="GPS" value={v.salida.gps ? `${v.salida.gps.lat}, ${v.salida.gps.lng}` : "No disponible"} />
                  <InfoRow label="NÂ° Registro" value={`#${String(v.salida.consecutivo).padStart(4,"0")}`} />
                </>)}

                <div style={{ height:16 }} />
              </>);
            })()}
          </div>
        </div>
      )}

      {/* â”€â”€ VISITA DETAIL MODAL â”€â”€ */}
      {detailVisita && (
        <div style={{ position:"fixed", inset:0, background:"rgba(0,0,0,.55)", zIndex:100, display:"flex", alignItems:"center", justifyContent:"center", padding:20 }}
          onClick={e => e.target===e.currentTarget && setDetailVisita(null)}>
          <div className="fade-in" style={{ background:T.white, borderRadius:18, width:"100%", maxWidth:460, maxHeight:"90vh", overflowY:"auto", boxShadow:"0 24px 64px rgba(0,0,0,.25)" }}>
            <div style={{ padding:"20px 20px 0", display:"flex", justifyContent:"space-between", alignItems:"center" }}>
              <span style={{ fontSize:12, fontWeight:700, color:T.muted, textTransform:"uppercase", letterSpacing:1 }}>Detalle de visita</span>
              <button onClick={() => setDetailVisita(null)} style={{ background:T.bg, border:"none", width:32, height:32, borderRadius:8, cursor:"pointer", fontSize:18, color:T.slate }}>Ã—</button>
            </div>

            {/* Header visita */}
            <div style={{ padding:"16px 20px 20px", borderBottom:`1px solid ${T.border}` }}>
              <div style={{ fontSize:22, fontWeight:900, color:T.navy }}>{detailVisita.empresa}</div>
              <div style={{ marginTop:8, display:"flex", gap:8, flexWrap:"wrap" }}>
                {{
                  completo:    <span style={{ background:T.greenLight, color:T.green, borderRadius:99, padding:"4px 14px", fontSize:13, fontWeight:700 }}>âœ… Visita Completa</span>,
                  adentro:     <span style={{ background:T.amberLight, color:"#92400e", borderRadius:99, padding:"4px 14px", fontSize:13, fontWeight:700 }}>ğŸŸ¡ Actualmente adentro</span>,
                  solo_salida: <span style={{ background:T.redLight,   color:T.red,    borderRadius:99, padding:"4px 14px", fontSize:13, fontWeight:700 }}>âš ï¸ Salida sin entrada</span>,
                }[detailVisita.status]}
                {detailVisita.duracionMin !== null && (
                  <span style={{ background:T.blueLight, color:T.blue, borderRadius:99, padding:"4px 14px", fontSize:13, fontWeight:700 }}>
                    â± {fmtDuracion(detailVisita.duracionMin)}
                  </span>
                )}
              </div>
            </div>

            {/* LÃ­nea de tiempo visual */}
            <div style={{ padding:"20px 20px 0" }}>
              <div style={{ fontSize:12, fontWeight:700, color:T.muted, textTransform:"uppercase", letterSpacing:1, marginBottom:14 }}>LÃ­nea de tiempo</div>
              <div style={{ display:"flex", flexDirection:"column", gap:0 }}>
                {/* Entrada */}
                <div style={{ display:"flex", gap:14, alignItems:"flex-start" }}>
                  <div style={{ display:"flex", flexDirection:"column", alignItems:"center", width:28 }}>
                    <div style={{ width:28, height:28, borderRadius:99, background: detailVisita.entrada ? T.greenLight : T.bg, border:`2px solid ${detailVisita.entrada ? T.green : T.border}`, display:"flex", alignItems:"center", justifyContent:"center", fontSize:14, flexShrink:0 }}>
                      {detailVisita.entrada ? "â†‘" : "â€”"}
                    </div>
                    <div style={{ width:2, height:40, background: detailVisita.entrada && detailVisita.salida ? T.green : T.border, margin:"4px 0" }} />
                  </div>
                  <div style={{ paddingTop:4, flex:1 }}>
                    <div style={{ fontSize:13, fontWeight:700, color: detailVisita.entrada ? T.green : T.muted }}>
                      {detailVisita.entrada ? "ENTRADA" : "Sin entrada registrada"}
                    </div>
                    {detailVisita.entrada && (
                      <div style={{ fontSize:12, color:T.muted, marginTop:2 }}>
                        {fmtDate(detailVisita.entrada.timestamp)} Â· <strong style={{color:T.navyMid}}>{fmtTime(detailVisita.entrada.timestamp)}</strong>
                        {" Â· "}Reg #{String(detailVisita.entrada.consecutivo).padStart(4,"0")}
                      </div>
                    )}
                  </div>
                </div>
                {/* Salida */}
                <div style={{ display:"flex", gap:14, alignItems:"flex-start" }}>
                  <div style={{ width:28, height:28, borderRadius:99, background: detailVisita.salida ? T.redLight : T.bg, border:`2px solid ${detailVisita.salida ? T.red : T.border}`, display:"flex", alignItems:"center", justifyContent:"center", fontSize:14, flexShrink:0 }}>
                    {detailVisita.salida ? "â†“" : detailVisita.status === "adentro" ? "â‹¯" : "â€”"}
                  </div>
                  <div style={{ paddingTop:4, flex:1 }}>
                    <div style={{ fontSize:13, fontWeight:700, color: detailVisita.salida ? T.red : detailVisita.status === "adentro" ? T.amber : T.muted }}>
                      {detailVisita.salida ? "SALIDA" : detailVisita.status === "adentro" ? "AÃºn adentro..." : "Sin salida registrada"}
                    </div>
                    {detailVisita.salida && (
                      <div style={{ fontSize:12, color:T.muted, marginTop:2 }}>
                        {fmtDate(detailVisita.salida.timestamp)} Â· <strong style={{color:T.navyMid}}>{fmtTime(detailVisita.salida.timestamp)}</strong>
                        {" Â· "}Reg #{String(detailVisita.salida.consecutivo).padStart(4,"0")}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>

            {/* Info adicional */}
            <div style={{ margin:"16px 0 0" }}>
              <InfoRow label="ğŸ“ Sede" value={detailVisita.sedeName} />
              {detailVisita.entrada && <InfoRow label="ğŸ‘¤ RegistrÃ³ entrada" value={detailVisita.entrada.guardiaName} />}
              {detailVisita.salida  && <InfoRow label="ğŸ‘¤ RegistrÃ³ salida"  value={detailVisita.salida.guardiaName} />}
              {detailVisita.duracionMin !== null && (
                <InfoRow label="â± Tiempo en sede" value={<strong style={{ color: T.blue }}>{fmtDuracion(detailVisita.duracionMin)}</strong>} />
              )}
            </div>

            <div style={{ height:20 }} />
          </div>
        </div>
      )}


      {showExportModal && (
        <div style={{ position:"fixed", inset:0, background:"rgba(0,0,0,.6)", zIndex:200, display:"flex", alignItems:"center", justifyContent:"center", padding:20 }}
          onClick={e => e.target===e.currentTarget && setShowExportModal(false)}>
          <div className="fade-in" style={{ background:T.white, borderRadius:20, width:"100%", maxWidth:480, maxHeight:"85vh", display:"flex", flexDirection:"column", boxShadow:"0 24px 64px rgba(0,0,0,.25)", overflow:"hidden" }}>

            {/* Header */}
            <div style={{ background:"#05200b", padding:"20px 24px", display:"flex", justifyContent:"space-between", alignItems:"center" }}>
              <div>
                <div style={{ color:"#fff", fontSize:20, fontWeight:900 }}>ğŸ“Š Exportar a CSV</div>
                <div style={{ color:"#7dd105", fontSize:12, marginTop:4, display:"flex", flexWrap:"wrap", gap:8 }}>
                  <span>{registros.length} registros totales</span>
                  <span>Â·</span>
                  <span>{filtered.length} con filtros actuales</span>
                  {(filterDateFrom || filterDateTo) && (
                    <span style={{ background:"rgba(125,209,5,.15)", color:"#7dd105", borderRadius:99, padding:"1px 8px", fontSize:11, fontWeight:700 }}>
                      ğŸ“… {filterDateFrom || "â€¦"} â†’ {filterDateTo || "â€¦"}
                    </span>
                  )}
                </div>
              </div>
              <button onClick={() => setShowExportModal(false)} style={{ background:"rgba(255,255,255,.15)", border:"none", color:"#fff", width:32, height:32, borderRadius:8, cursor:"pointer", fontSize:18 }}>Ã—</button>
            </div>

            <div style={{ padding:24, overflowY:"auto", flex:1 }}>
              {/* Rango de fecha en el modal */}
              <div style={{ marginBottom:20, background:T.bg, borderRadius:12, padding:14, border:`1px solid ${T.border}` }}>
                <p style={{ fontSize:12, fontWeight:800, color:T.brand, textTransform:"uppercase", letterSpacing:.5, marginBottom:10 }}>ğŸ“… Rango de fechas para la descarga</p>
                <div style={{ display:"flex", gap:8, marginBottom:10 }}>
                  {[
                    { label:"Hoy", fn: () => { const n=new Date(),d=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`; setFilterDateFrom(d); setFilterDateTo(d); }},
                    { label:"Ayer", fn: () => { const y=new Date(Date.now()-86400000),d=`${y.getFullYear()}-${String(y.getMonth()+1).padStart(2,'0')}-${String(y.getDate()).padStart(2,'0')}`; setFilterDateFrom(d); setFilterDateTo(d); }},
                    { label:"Esta semana", fn: () => { const now=new Date(),day=now.getDay()||7,mon=new Date(now); mon.setDate(now.getDate()-day+1); const tl=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; setFilterDateFrom(tl(mon)); setFilterDateTo(tl(now)); }},
                    { label:"Este mes", fn: () => { const now=new Date(),first=new Date(now.getFullYear(),now.getMonth(),1); const tl=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; setFilterDateFrom(tl(first)); setFilterDateTo(tl(now)); }},
                    { label:"Todo", fn: () => { setFilterDateFrom(""); setFilterDateTo(""); }},
                  ].map(({ label, fn }) => (
                    <button key={label} onClick={fn} style={{
                      padding:"5px 10px", borderRadius:8, border:`1px solid ${T.border}`,
                      background:T.white, color:T.slate, fontSize:11, fontWeight:600, cursor:"pointer"
                    }}>{label}</button>
                  ))}
                </div>
                <div style={{ display:"flex", gap:10 }}>
                  <div style={{ flex:1 }}>
                    <div style={{ fontSize:11, color:T.muted, marginBottom:4 }}>Desde</div>
                    <input type="date" value={filterDateFrom} onChange={e => setFilterDateFrom(e.target.value)}
                      style={{ width:"100%", padding:"8px 10px", borderRadius:8, border:`1px solid ${filterDateFrom ? T.brand : T.border}`, fontSize:13, background:T.white }} />
                  </div>
                  <div style={{ flex:1 }}>
                    <div style={{ fontSize:11, color:T.muted, marginBottom:4 }}>Hasta</div>
                    <input type="date" value={filterDateTo} onChange={e => setFilterDateTo(e.target.value)}
                      style={{ width:"100%", padding:"8px 10px", borderRadius:8, border:`1px solid ${filterDateTo ? T.brand : T.border}`, fontSize:13, background:T.white }} />
                  </div>
                </div>
                <div style={{ marginTop:8, fontSize:12, color:T.muted }}>
                  {filtered.length} registro{filtered.length !== 1 ? "s" : ""} en el rango seleccionado
                </div>
              </div>

              {/* Descarga directa */}
              <div style={{ marginBottom:20 }}>
                <div style={{ display:"flex", alignItems:"center", gap:8, marginBottom:14 }}>
                  <div style={{ width:32, height:32, background:"#dcfce7", borderRadius:8, display:"flex", alignItems:"center", justifyContent:"center", fontSize:18 }}>â¬‡ï¸</div>
                  <div>
                    <div style={{ fontSize:15, fontWeight:800, color:T.navy }}>Descarga directa</div>
                    <div style={{ fontSize:12, color:T.muted }}>Genera el archivo .xlsx en este dispositivo</div>
                  </div>
                </div>
                <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr 1fr", gap:10 }}>
                  <button onClick={() => exportarExcel("todos")} disabled={exporting} style={{
                    padding:"14px 8px", borderRadius:12, border:`2px solid #16a34a`,
                    background:"#f0fdf4", color:"#15803d", cursor:"pointer", fontWeight:700, fontSize:12,
                    display:"flex", flexDirection:"column", alignItems:"center", gap:4
                  }}>
                    {exporting ? <Spinner /> : <span style={{fontSize:22}}>ğŸ“‹</span>}
                    <span>Todos</span>
                    <span style={{ fontSize:10, fontWeight:400, color:T.muted }}>{registros.length} filas</span>
                  </button>
                  <button onClick={() => exportarExcel("filtrado")} disabled={exporting} style={{
                    padding:"14px 8px", borderRadius:12, border:`2px solid #2563eb`,
                    background:"#eff6ff", color:"#1d4ed8", cursor:"pointer", fontWeight:700, fontSize:12,
                    display:"flex", flexDirection:"column", alignItems:"center", gap:4
                  }}>
                    {exporting ? <Spinner /> : <span style={{fontSize:22}}>ğŸ”</span>}
                    <span>Filtrado</span>
                    <span style={{ fontSize:10, fontWeight:400, color:T.muted }}>{filtered.length} filas</span>
                  </button>
                  <button onClick={() => exportarExcel("visitas")} disabled={exporting} style={{
                    padding:"14px 8px", borderRadius:12, border:`2px solid #7c3aed`,
                    background:"#ede9fe", color:"#5b21b6", cursor:"pointer", fontWeight:700, fontSize:12,
                    display:"flex", flexDirection:"column", alignItems:"center", gap:4
                  }}>
                    {exporting ? <Spinner /> : <span style={{fontSize:22}}>ğŸ”„</span>}
                    <span>Visitas</span>
                    <span style={{ fontSize:10, fontWeight:400, color:T.muted }}>{visitas.length} visitas</span>
                  </button>
                </div>
                <div style={{ marginTop:10, padding:"10px 12px", background:T.bg, borderRadius:8, fontSize:12, color:T.slate }}>
                  ğŸ’¡ Descarga como <strong>MercaControl_[fecha].csv</strong> â€” Excel lo abre automÃ¡ticamente con todos los datos organizados en columnas. TambiÃ©n compatible con Google Sheets.
                </div>
              </div>

              <div style={{ display:"flex", alignItems:"center", gap:10, margin:"20px 0" }}>
                <div style={{ flex:1, height:1, background:T.border }} />
                <span style={{ fontSize:12, color:T.muted, fontWeight:600 }}>o conecta a la nube</span>
                <div style={{ flex:1, height:1, background:T.border }} />
              </div>

              {/* Nube SharePoint */}
              <div style={{ border:`2px solid #e0e7ff`, borderRadius:14, overflow:"hidden" }}>
                <div style={{ background:"#eef2ff", padding:"14px 16px", display:"flex", alignItems:"center", gap:10 }}>
                  <span style={{ fontSize:28 }}>â˜ï¸</span>
                  <div>
                    <div style={{ fontSize:14, fontWeight:800, color:"#3730a3" }}>SincronizaciÃ³n automÃ¡tica con SharePoint</div>
                    <div style={{ fontSize:12, color:"#6366f1" }}>Requiere integraciÃ³n con Microsoft Graph API</div>
                  </div>
                </div>
                <div style={{ padding:16 }}>
                  <div style={{ fontSize:13, color:T.slate, lineHeight:1.7, marginBottom:14 }}>
                    Con tu plan <strong>Microsoft 365 empresarial</strong> puedes conectar MercaControl para que <strong>cada registro nuevo se escriba automÃ¡ticamente</strong> en un Excel en SharePoint/OneDrive, sin hacer nada manual.
                  </div>
                  <div style={{ display:"flex", flexDirection:"column", gap:8, marginBottom:14 }}>
                    {[
                      ["1","Registrar la app en Azure AD Portal","portal.azure.com â†’ App registrations"],
                      ["2","Activar permisos Microsoft Graph","Files.ReadWrite.All en tu tenant"],
                      ["3","Pegar el Client ID en la configuraciÃ³n","Solo el admin lo hace una vez"],
                      ["4","Seleccionar el archivo Excel en OneDrive","Se crea automÃ¡ticamente si no existe"],
                    ].map(([n,t,s]) => (
                      <div key={n} style={{ display:"flex", gap:10, alignItems:"flex-start" }}>
                        <div style={{ width:22, height:22, borderRadius:99, background:"#4f46e5", color:"#fff", fontSize:11, fontWeight:800, display:"flex", alignItems:"center", justifyContent:"center", flexShrink:0, marginTop:1 }}>{n}</div>
                        <div>
                          <div style={{ fontSize:13, fontWeight:600, color:T.navyMid }}>{t}</div>
                          <div style={{ fontSize:11, color:T.muted }}>{s}</div>
                        </div>
                      </div>
                    ))}
                  </div>
                  <div style={{ background:"#f0f9ff", border:"1px solid #bae6fd", borderRadius:8, padding:"10px 12px", fontSize:12, color:"#0369a1" }}>
                    ğŸ”’ <strong>Costo adicional: $0</strong> â€” Microsoft Graph API estÃ¡ incluido en tu plan M365 empresarial existente. Solo necesitas que el administrador de IT registre la app en Azure AD.
                  </div>
                  {!isViewer && (
                    <button style={{ marginTop:12, width:"100%", padding:"12px", borderRadius:10, border:"none", background:"#7dd105", color:"#05200b", fontWeight:800, fontSize:13, cursor:"pointer" }}
                      onClick={() => { setShowExportModal(false); onOpenPanel(); }}>
                      âš™ï¸ Configurar integraciÃ³n SharePoint
                    </button>
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// â”€â”€â”€ Comercial Empresas Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ComercialEmpresasPanel({ empresas, onUpdateEmpresas }) {
  const [newEmp, setNewEmp] = useState("");
  const [empSearch, setEmpSearch] = useState("");
  const empFilt = empresas.filter(e => e.nombre.toLowerCase().includes(empSearch.toLowerCase()));

  return (
    <div>
      {/* Agregar */}
      <div style={{ background: "#f0f9ff", borderRadius: 12, padding: 16, marginBottom: 16, border: "1px solid #bae6fd" }}>
        <h4 style={{ fontSize: 14, fontWeight: 800, color: "#0369a1", marginBottom: 10 }}>Agregar empresa</h4>
        <div style={{ display: "flex", gap: 8 }}>
          <input value={newEmp} onChange={e => setNewEmp(e.target.value)}
            placeholder="Nombre de la empresa..."
            onKeyDown={e => { if (e.key === "Enter" && newEmp.trim()) { onUpdateEmpresas([...empresas, { id: `e${Date.now()}`, nombre: newEmp.trim(), activa: true }]); setNewEmp(""); } }}
            style={{ flex: 1, padding: "10px 12px", borderRadius: 8, border: "1px solid #bae6fd", fontSize: 14 }} />
          <button onClick={() => { if (newEmp.trim()) { onUpdateEmpresas([...empresas, { id: `e${Date.now()}`, nombre: newEmp.trim(), activa: true }]); setNewEmp(""); } }}
            style={{ padding: "10px 16px", borderRadius: 8, border: "none", background: "#0ea5e9", color: "#fff", cursor: "pointer", fontWeight: 800 }}>+ Agregar</button>
        </div>
      </div>

      {/* Lista */}
      <div style={{ background: T.white, borderRadius: 12, border: `1px solid ${T.border}`, overflow: "hidden" }}>
        <div style={{ padding: "10px 14px", borderBottom: `1px solid ${T.border}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
          <span style={{ fontSize: 13, fontWeight: 700, color: T.slate }}>
            {empresas.filter(e => e.activa).length} activas Â· {empresas.filter(e => !e.activa).length} inactivas
          </span>
          <input value={empSearch} onChange={e => setEmpSearch(e.target.value)} placeholder="Buscar..."
            style={{ padding: "5px 10px", borderRadius: 8, border: `1px solid ${T.border}`, fontSize: 13, width: 130 }} />
        </div>
        <div style={{ maxHeight: 360, overflowY: "auto" }}>
          {empFilt.map(e => (
            <div key={e.id} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "10px 14px", borderBottom: `1px solid ${T.border}` }}>
              <span style={{ fontSize: 13, color: e.activa ? T.navyMid : T.muted, textDecoration: e.activa ? "none" : "line-through" }}>{e.nombre}</span>
              <button onClick={() => onUpdateEmpresas(empresas.map(x => x.id === e.id ? { ...x, activa: !x.activa } : x))}
                style={{ padding: "4px 12px", borderRadius: 20, border: "none", cursor: "pointer", fontSize: 11, fontWeight: 700, background: e.activa ? T.redLight : T.greenLight, color: e.activa ? T.red : T.green }}>
                {e.activa ? "Desactivar" : "Activar"}
              </button>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

// â”€â”€â”€ Admin Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function AdminPanel({ user, sedes, empresas, admins, viewers, guardias, comercials, onUpdateSedes, onUpdateEmpresas, onUpdateAdmins, onUpdateViewers, onUpdateGuardias, onUpdateComercials, onClose }) {
  const [tab, setTab] = useState("empresas");
  const [newEmp, setNewEmp] = useState("");
  const [newSede, setNewSede] = useState("");
  const [newAdmin, setNewAdmin] = useState("");
  const [newViewer, setNewViewer] = useState("");
  const [newGuardiaEmail, setNewGuardiaEmail] = useState("");
  const [newGuardiaSedeId, setNewGuardiaSedeId] = useState("");
  const [newComercial, setNewComercial] = useState("");
  const [empSearch, setEmpSearch] = useState("");
  const [sedeSearch, setSedeSearch] = useState("");

  const sedesActivas = sedes.filter(s => s.activa);
  const empFilt  = empresas.filter(e => e.nombre.toLowerCase().includes(empSearch.toLowerCase()));
  const sedeFilt = sedes.filter(s => s.nombre.toLowerCase().includes(sedeSearch.toLowerCase()));

  return (
    <div style={{ minHeight: "100vh", background: T.bg }}>
      <div style={{ background: T.navy, padding: "16px 20px", display: "flex", justifyContent: "space-between", alignItems: "center" }}>
        <div>
          <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 4 }}>
            <img src={LOGO_SRC} alt="CaÃ±averal" style={{ height: 32, width: 32, borderRadius: "50%", objectFit: "cover", border: "2px solid rgba(255,255,255,.2)" }} />
          </div>
          <div style={{ color: "#fff", fontSize: 20, fontWeight: 800 }}>âš™ï¸ Panel de AdministraciÃ³n</div>
        </div>
        <button onClick={onClose} style={{ background: "rgba(255,255,255,.1)", border: "none", color: "#fff", padding: "10px 18px", borderRadius: 10, cursor: "pointer", fontWeight: 700 }}>â† Volver</button>
      </div>

      {/* Tabs */}
      <div style={{ background: T.white, borderBottom: `1px solid ${T.border}`, display: "flex", padding: "0 20px", overflowX: "auto" }}>
        {[["empresas", "ğŸ­ Empresas", empresas.filter(e => e.activa).length],
          ["sedes", "ğŸ“ Sedes", sedes.filter(s => s.activa).length],
          ["guardias", "ğŸ›¡ï¸ Guardias", guardias.length],
          ["comercials", "ğŸ­ Comerciales", comercials.length],
          ["admins", "ğŸ‘‘ Admins", admins.length],
          ["viewers", "ğŸ‘ï¸ Espectadores", viewers.length]].map(([t, l, c]) => (
          <button key={t} onClick={() => setTab(t)} style={{
            padding: "14px 20px", border: "none", background: "none", cursor: "pointer", whiteSpace: "nowrap",
            fontWeight: tab === t ? 800 : 500, fontSize: 14,
            color: tab === t ? T.navy : T.slate,
            borderBottom: `3px solid ${tab === t ? T.brand : "transparent"}`,
            display: "flex", alignItems: "center", gap: 8
          }}>
            {l}
            <span style={{ background: tab === t ? T.amberLight : T.bg, color: tab === t ? "#92400e" : T.slate, borderRadius: 99, padding: "1px 7px", fontSize: 11, fontWeight: 700 }}>{c}</span>
          </button>
        ))}
      </div>

      <div style={{ padding: 20, maxWidth: 640, margin: "0 auto" }}>
        {/* EMPRESAS */}
        {tab === "empresas" && (
          <div>
            <div style={{ background: T.white, borderRadius: 14, padding: 18, marginBottom: 16, border: `1px solid ${T.border}` }}>
              <h4 style={{ fontSize: 14, fontWeight: 800, color: T.navy, marginBottom: 12 }}>Agregar empresa</h4>
              <div style={{ display: "flex", gap: 10 }}>
                <input value={newEmp} onChange={e => setNewEmp(e.target.value)}
                  placeholder="Nombre de la empresa..."
                  onKeyDown={e => { if (e.key === "Enter" && newEmp.trim()) { onUpdateEmpresas([...empresas, { id: `e${Date.now()}`, nombre: newEmp.trim(), activa: true }]); setNewEmp(""); } }}
                  style={{ flex: 1, padding: "11px 14px", borderRadius: 8, border: `1px solid ${T.border}`, fontSize: 14 }} />
                <button onClick={() => { if (newEmp.trim()) { onUpdateEmpresas([...empresas, { id: `e${Date.now()}`, nombre: newEmp.trim(), activa: true }]); setNewEmp(""); } }}
                  style={{ padding: "11px 18px", borderRadius: 8, border: "none", background: "#7dd105", color: "#05200b", cursor: "pointer", fontWeight: 800 }}>+ Agregar</button>
              </div>
              {/* Importar CSV */}
              <div style={{ marginTop: 14, paddingTop: 14, borderTop: `1px solid ${T.border}` }}>
                <div style={{ fontSize: 13, fontWeight: 700, color: T.slate, marginBottom: 8 }}>ğŸ“¥ Importar desde archivo</div>
                <div style={{ fontSize: 12, color: T.muted, marginBottom: 10 }}>
                  Sube un archivo <strong>.txt o .csv</strong> con <strong>un nombre por lÃ­nea</strong>. Se agregarÃ¡n todas las que no existan ya.
                </div>
                <label style={{ display: "inline-flex", alignItems: "center", gap: 8, padding: "10px 16px", borderRadius: 8, background: "#f0fdf4", border: `1.5px dashed #7dd105`, cursor: "pointer", fontSize: 13, fontWeight: 700, color: "#3a6200" }}>
                  ğŸ“‚ Seleccionar archivo
                  <input type="file" accept=".csv,.txt" style={{ display: "none" }} onChange={e => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = ev => {
                      const lines = ev.target.result.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0);
                      const existentes = new Set(empresas.map(x => x.nombre.toLowerCase()));
                      const nuevas = lines.filter(l => !existentes.has(l.toLowerCase())).map(nombre => ({ id: `e${Date.now()}-${Math.random().toString(36).slice(2)}`, nombre, activa: true }));
                      if (nuevas.length > 0) onUpdateEmpresas([...empresas, ...nuevas]);
                      alert(`âœ… ${nuevas.length} empresa(s) importadas. ${lines.length - nuevas.length} omitidas (ya existÃ­an).`);
                      e.target.value = "";
                    };
                    reader.readAsText(file);
                  }} />
                </label>
              </div>
            </div>

            <div style={{ background: T.white, borderRadius: 14, overflow: "hidden", border: `1px solid ${T.border}` }}>
              <div style={{ padding: "12px 16px", borderBottom: `1px solid ${T.border}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                <span style={{ fontSize: 13, fontWeight: 700, color: T.slate }}>
                  {empresas.filter(e => e.activa).length} activas Â· {empresas.filter(e => !e.activa).length} inactivas
                </span>
                <input value={empSearch} onChange={e => setEmpSearch(e.target.value)} placeholder="Buscar..."
                  style={{ padding: "6px 10px", borderRadius: 8, border: `1px solid ${T.border}`, fontSize: 13, width: 140 }} />
              </div>
              <div style={{ maxHeight: 420, overflowY: "auto" }}>
                {empFilt.map(e => (
                  <div key={e.id} style={{
                    display: "flex", justifyContent: "space-between", alignItems: "center",
                    padding: "11px 16px", borderBottom: `1px solid ${T.border}`
                  }}>
                    <span style={{ fontSize: 13, color: e.activa ? T.navyMid : T.muted, textDecoration: e.activa ? "none" : "line-through" }}>{e.nombre}</span>
                    <div style={{ display: "flex", gap: 6 }}>
                      <button onClick={() => onUpdateEmpresas(empresas.map(x => x.id === e.id ? { ...x, activa: !x.activa } : x))}
                        style={{ padding: "4px 12px", borderRadius: 20, border: "none", cursor: "pointer", fontSize: 11, fontWeight: 700, background: e.activa ? T.redLight : T.greenLight, color: e.activa ? T.red : T.green }}>
                        {e.activa ? "Desactivar" : "Activar"}
                      </button>
                      <button onClick={() => { if (window.confirm(`Â¿Eliminar "${e.nombre}"? Esta acciÃ³n no se puede deshacer.`)) onUpdateEmpresas(empresas.filter(x => x.id !== e.id)); }}
                        style={{ padding: "4px 10px", borderRadius: 20, border: "none", cursor: "pointer", fontSize: 11, fontWeight: 700, background: "#fee2e2", color: "#b91c1c" }}>
                        ğŸ—‘ï¸
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}

        {/* SEDES */}
        {tab === "sedes" && (
          <div>
            <div style={{ background: T.white, borderRadius: 14, padding: 18, marginBottom: 16, border: `1px solid ${T.border}` }}>
              <h4 style={{ fontSize: 14, fontWeight: 800, color: T.navy, marginBottom: 12 }}>Agregar sede</h4>
              <div style={{ display: "flex", gap: 10 }}>
                <input value={newSede} onChange={e => setNewSede(e.target.value)} placeholder="Nombre de la sede..."
                  onKeyDown={e => { if (e.key === "Enter" && newSede.trim()) { onUpdateSedes([...sedes, { id: `s${Date.now()}`, nombre: newSede.trim(), activa: true }]); setNewSede(""); } }}
                  style={{ flex: 1, padding: "11px 14px", borderRadius: 8, border: `1px solid ${T.border}`, fontSize: 14 }} />
                <button onClick={() => { if (newSede.trim()) { onUpdateSedes([...sedes, { id: `s${Date.now()}`, nombre: newSede.trim(), activa: true }]); setNewSede(""); } }}
                  style={{ padding: "11px 18px", borderRadius: 8, border: "none", background: "#7dd105", color: "#05200b", cursor: "pointer", fontWeight: 800 }}>+ Agregar</button>
              </div>
              {/* Importar CSV */}
              <div style={{ marginTop: 14, paddingTop: 14, borderTop: `1px solid ${T.border}` }}>
                <div style={{ fontSize: 13, fontWeight: 700, color: T.slate, marginBottom: 8 }}>ğŸ“¥ Importar desde archivo</div>
                <div style={{ fontSize: 12, color: T.muted, marginBottom: 10 }}>
                  Sube un archivo <strong>.txt o .csv</strong> con <strong>un nombre por lÃ­nea</strong>. Se agregarÃ¡n todas las que no existan ya.
                </div>
                <label style={{ display: "inline-flex", alignItems: "center", gap: 8, padding: "10px 16px", borderRadius: 8, background: "#f0fdf4", border: `1.5px dashed #7dd105`, cursor: "pointer", fontSize: 13, fontWeight: 700, color: "#3a6200" }}>
                  ğŸ“‚ Seleccionar archivo
                  <input type="file" accept=".csv,.txt" style={{ display: "none" }} onChange={e => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = ev => {
                      const lines = ev.target.result.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0);
                      const existentes = new Set(sedes.map(x => x.nombre.toLowerCase()));
                      const nuevas = lines.filter(l => !existentes.has(l.toLowerCase())).map(nombre => ({ id: `s${Date.now()}-${Math.random().toString(36).slice(2)}`, nombre, activa: true }));
                      if (nuevas.length > 0) onUpdateSedes([...sedes, ...nuevas]);
                      alert(`âœ… ${nuevas.length} sede(s) importadas. ${lines.length - nuevas.length} omitidas (ya existÃ­an).`);
                      e.target.value = "";
                    };
                    reader.readAsText(file);
                  }} />
                </label>
              </div>
            </div>
            <div style={{ background: T.white, borderRadius: 14, overflow: "hidden", border: `1px solid ${T.border}` }}>
              <div style={{ padding: "12px 16px", borderBottom: `1px solid ${T.border}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                <span style={{ fontSize: 13, fontWeight: 700, color: T.slate }}>
                  {sedes.filter(s => s.activa).length} activas Â· {sedes.filter(s => !s.activa).length} inactivas
                </span>
                <input value={sedeSearch} onChange={e => setSedeSearch(e.target.value)} placeholder="Buscar..."
                  style={{ padding: "6px 10px", borderRadius: 8, border: `1px solid ${T.border}`, fontSize: 13, width: 140 }} />
              </div>
              <div style={{ maxHeight: 420, overflowY: "auto" }}>
                {sedeFilt.map(s => (
                  <div key={s.id} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "11px 16px", borderBottom: `1px solid ${T.border}` }}>
                    <span style={{ fontSize: 13, color: s.activa ? T.navyMid : T.muted, textDecoration: s.activa ? "none" : "line-through" }}>{s.nombre}</span>
                    <div style={{ display: "flex", gap: 6 }}>
                      <button onClick={() => onUpdateSedes(sedes.map(x => x.id === s.id ? { ...x, activa: !x.activa } : x))}
                        style={{ padding: "4px 12px", borderRadius: 20, border: "none", cursor: "pointer", fontSize: 11, fontWeight: 700, background: s.activa ? T.redLight : T.greenLight, color: s.activa ? T.red : T.green }}>
                        {s.activa ? "Desactivar" : "Activar"}
                      </button>
                      <button onClick={() => { if (window.confirm(`Â¿Eliminar "${s.nombre}"? Esta acciÃ³n no se puede deshacer.`)) onUpdateSedes(sedes.filter(x => x.id !== s.id)); }}
                        style={{ padding: "4px 10px", borderRadius: 20, border: "none", cursor: "pointer", fontSize: 11, fontWeight: 700, background: "#fee2e2", color: "#b91c1c" }}>
                        ğŸ—‘ï¸
                      </button>
                    </div>
                  </div>
                ))}
                {sedeFilt.length === 0 && (
                  <div style={{ padding: "24px", textAlign: "center", color: T.muted, fontSize: 13 }}>
                    {sedeSearch ? `Sin resultados para "${sedeSearch}"` : "No hay sedes registradas"}
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {/* ADMINS */}
        {tab === "admins" && (
          <div>
            <div style={{ background: "#f2fde4", border: `1px solid #7dd105`, borderRadius: 12, padding: 14, marginBottom: 16, fontSize: 13, color: "#3a6200", lineHeight: 1.5 }}>
              âš ï¸ En producciÃ³n, los permisos de admin se gestionan vÃ­a <strong>Azure AD Groups</strong> en Microsoft 365. AquÃ­ se simula el control de acceso.
            </div>
            <div style={{ background: T.white, borderRadius: 14, padding: 18, marginBottom: 16, border: `1px solid ${T.border}` }}>
              <h4 style={{ fontSize: 14, fontWeight: 800, color: T.navy, marginBottom: 12 }}>Designar administrador</h4>
              <div style={{ display: "flex", gap: 10 }}>
                <input value={newAdmin} onChange={e => setNewAdmin(e.target.value)} placeholder="Email Microsoft del usuario..."
                  style={{ flex: 1, padding: "11px 14px", borderRadius: 8, border: `1px solid ${T.border}`, fontSize: 14 }} />
                <button onClick={() => { if (newAdmin.trim()) { onUpdateAdmins([...admins, { email: newAdmin.trim(), addedBy: user.email, addedAt: Date.now() }]); setNewAdmin(""); } }}
                  style={{ padding: "11px 18px", borderRadius: 8, border: "none", background: "#7dd105", color: "#05200b", cursor: "pointer", fontWeight: 800 }}>+ Agregar</button>
              </div>
            </div>
            <div style={{ background: T.white, borderRadius: 14, overflow: "hidden", border: `1px solid ${T.border}` }}>
              <div style={{ padding: "12px 16px", borderBottom: `1px solid ${T.border}`, fontSize: 13, fontWeight: 700, color: T.slate }}>
                ğŸ‘‘ {admins.length} administrador{admins.length !== 1 ? "es" : ""}
              </div>
              {admins.map((a, i) => (
                <div key={i} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "12px 16px", borderBottom: `1px solid ${T.border}` }}>
                  <div>
                    <div style={{ fontSize: 14, fontWeight: 600, color: T.navyMid }}>{a.email}</div>
                    <div style={{ fontSize: 11, color: T.muted }}>Agregado: {a.addedAt ? fmtDate(a.addedAt) : "â€”"}</div>
                  </div>
                  {a.email !== user.email ? (
                    <button onClick={() => onUpdateAdmins(admins.filter((_, j) => j !== i))}
                      style={{ padding: "5px 12px", borderRadius: 20, border: "none", cursor: "pointer", fontSize: 12, fontWeight: 700, background: T.redLight, color: T.red }}>
                      Quitar
                    </button>
                  ) : (
                    <span style={{ fontSize: 11, color: "#3a6200", fontWeight: 700, background: T.accentLight, padding: "2px 8px", borderRadius: 99 }}>TÃº âœ“</span>
                  )}
                </div>
              ))}
            </div>
          </div>
        )}

        {/* GUARDIAS */}
        {tab === "guardias" && (
          <div>
            <div style={{ background: "#ecfdf5", border: `1px solid #6ee7b7`, borderRadius: 12, padding: 14, marginBottom: 16, fontSize: 13, color: "#065f46", lineHeight: 1.6 }}>
              ğŸ›¡ï¸ Los <strong>guardias de seguridad</strong> pueden registrar entradas y salidas en su sede asignada. El admin asigna el correo y la sede â€” el guardia no puede cambiarla.
            </div>
            <div style={{ background: T.white, borderRadius: 14, padding: 18, marginBottom: 16, border: `1px solid ${T.border}` }}>
              <h4 style={{ fontSize: 14, fontWeight: 800, color: T.navy, marginBottom: 12 }}>Agregar guardia</h4>
              <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
                <input value={newGuardiaEmail} onChange={e => setNewGuardiaEmail(e.target.value)}
                  placeholder="Email Microsoft del guardia..."
                  style={{ flex: 1, padding: "11px 14px", borderRadius: 8, border: `1px solid ${T.border}`, fontSize: 14 }} />
                <select value={newGuardiaSedeId} onChange={e => setNewGuardiaSedeId(e.target.value)}
                  style={{ padding: "11px 14px", borderRadius: 8, border: `1px solid ${T.border}`, fontSize: 14, background: "#fff" }}>
                  <option value="">-- Selecciona la sede --</option>
                  {sedesActivas.map(s => <option key={s.id} value={s.id}>{s.nombre}</option>)}
                </select>
                <button onClick={() => {
                  if (newGuardiaEmail.trim() && newGuardiaSedeId) {
                    onUpdateGuardias([...guardias, { email: newGuardiaEmail.trim().toLowerCase(), sedeId: newGuardiaSedeId, addedBy: user.email, addedAt: Date.now() }]);
                    setNewGuardiaEmail(""); setNewGuardiaSedeId("");
                  }
                }} disabled={!newGuardiaEmail.trim() || !newGuardiaSedeId}
                  style={{ padding: "11px 18px", borderRadius: 8, border: "none", background: (!newGuardiaEmail.trim() || !newGuardiaSedeId) ? "#334155" : T.brand, color: "#fff", cursor: "pointer", fontWeight: 700 }}>
                  + Agregar guardia
                </button>
              </div>
            </div>
            <div style={{ background: T.white, borderRadius: 14, overflow: "hidden", border: `1px solid ${T.border}` }}>
              <div style={{ padding: "12px 16px", borderBottom: `1px solid ${T.border}`, fontSize: 13, fontWeight: 700, color: T.slate }}>
                ğŸ›¡ï¸ {guardias.length} guardia{guardias.length !== 1 ? "s" : ""} registrado{guardias.length !== 1 ? "s" : ""}
              </div>
              {guardias.length === 0 && (
                <div style={{ padding: "32px 20px", textAlign: "center", color: T.muted, fontSize: 13 }}>No hay guardias registrados aÃºn</div>
              )}
              {guardias.map((g, i) => {
                const sede = sedes.find(s => s.id === g.sedeId);
                return (
                  <div key={i} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "12px 16px", borderBottom: `1px solid ${T.border}` }}>
                    <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                      <div style={{ width: 28, height: 28, borderRadius: 8, background: "#dcfce7", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 14 }}>ğŸ›¡ï¸</div>
                      <div>
                        <div style={{ fontSize: 14, fontWeight: 600, color: T.navyMid }}>{g.email}</div>
                        <div style={{ fontSize: 11, color: T.muted }}>Sede: <strong>{sede?.nombre || "â€”"}</strong> Â· Agregado: {g.addedAt ? fmtDate(g.addedAt) : "â€”"}</div>
                      </div>
                    </div>
                    <button onClick={() => onUpdateGuardias(guardias.filter((_, j) => j !== i))}
                      style={{ padding: "5px 12px", borderRadius: 20, border: "none", cursor: "pointer", fontSize: 12, fontWeight: 700, background: T.redLight, color: T.red }}>
                      Quitar
                    </button>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* COMERCIALES */}
        {tab === "comercials" && (
          <div>
            <div style={{ background: "#f0f9ff", border: `1px solid #bae6fd`, borderRadius: 12, padding: 14, marginBottom: 16, fontSize: 13, color: "#0369a1", lineHeight: 1.6 }}>
              ğŸ­ Los <strong>comerciales</strong> pueden ver el dashboard, descargar Excel, y gestionar el catÃ¡logo de empresas (agregar y activar/desactivar). No pueden crear registros de entrada/salida.
            </div>
            <div style={{ background: T.white, borderRadius: 14, padding: 18, marginBottom: 16, border: `1px solid ${T.border}` }}>
              <h4 style={{ fontSize: 14, fontWeight: 800, color: T.navy, marginBottom: 12 }}>Agregar comercial</h4>
              <div style={{ display: "flex", gap: 10 }}>
                <input value={newComercial} onChange={e => setNewComercial(e.target.value)} placeholder="Email Microsoft del comercial..."
                  onKeyDown={e => { if (e.key === "Enter" && newComercial.trim()) { onUpdateComercials([...comercials, { email: newComercial.trim().toLowerCase(), addedBy: user.email, addedAt: Date.now() }]); setNewComercial(""); } }}
                  style={{ flex: 1, padding: "11px 14px", borderRadius: 8, border: `1px solid ${T.border}`, fontSize: 14 }} />
                <button onClick={() => { if (newComercial.trim()) { onUpdateComercials([...comercials, { email: newComercial.trim().toLowerCase(), addedBy: user.email, addedAt: Date.now() }]); setNewComercial(""); } }}
                  style={{ padding: "11px 18px", borderRadius: 8, border: "none", background: "#0ea5e9", color: "#fff", cursor: "pointer", fontWeight: 800 }}>+ Agregar</button>
              </div>
            </div>
            <div style={{ background: T.white, borderRadius: 14, overflow: "hidden", border: `1px solid ${T.border}` }}>
              <div style={{ padding: "12px 16px", borderBottom: `1px solid ${T.border}`, fontSize: 13, fontWeight: 700, color: T.slate }}>
                ğŸ­ {comercials.length} comercial{comercials.length !== 1 ? "es" : ""}
              </div>
              {comercials.length === 0 && (
                <div style={{ padding: "32px 20px", textAlign: "center", color: T.muted, fontSize: 13 }}>No hay comerciales registrados aÃºn</div>
              )}
              {comercials.map((c, i) => (
                <div key={i} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "12px 16px", borderBottom: `1px solid ${T.border}` }}>
                  <div>
                    <div style={{ fontSize: 14, fontWeight: 600, color: T.navyMid }}>{c.email}</div>
                    <div style={{ fontSize: 11, color: T.muted }}>Agregado: {c.addedAt ? fmtDate(c.addedAt) : "â€”"} Â· por {c.addedBy}</div>
                  </div>
                  <button onClick={() => onUpdateComercials(comercials.filter((_, j) => j !== i))}
                    style={{ padding: "5px 12px", borderRadius: 20, border: "none", cursor: "pointer", fontSize: 12, fontWeight: 700, background: T.redLight, color: T.red }}>
                    Quitar
                  </button>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* VIEWERS */}
        {tab === "viewers" && (
          <div>
            <div style={{ background: "#ede9fe", border: `1px solid #c4b5fd`, borderRadius: 12, padding: 14, marginBottom: 16, fontSize: 13, color: "#5b21b6", lineHeight: 1.6 }}>
              ğŸ‘ï¸ Los <strong>espectadores</strong> ven el dashboard en tiempo real igual que un admin, pero <strong>no pueden editar registros ni acceder al panel de configuraciÃ³n</strong>. Solo visualizan.
            </div>
            <div style={{ background: T.white, borderRadius: 14, padding: 18, marginBottom: 16, border: `1px solid ${T.border}` }}>
              <h4 style={{ fontSize: 14, fontWeight: 800, color: T.navy, marginBottom: 12 }}>Agregar espectador</h4>
              <div style={{ display: "flex", gap: 10 }}>
                <input value={newViewer} onChange={e => setNewViewer(e.target.value)} placeholder="Email Microsoft del espectador..."
                  onKeyDown={e => { if (e.key === "Enter" && newViewer.trim()) { onUpdateViewers([...viewers, { email: newViewer.trim(), addedBy: user.email, addedAt: Date.now() }]); setNewViewer(""); } }}
                  style={{ flex: 1, padding: "11px 14px", borderRadius: 8, border: `1px solid ${T.border}`, fontSize: 14 }} />
                <button onClick={() => { if (newViewer.trim()) { onUpdateViewers([...viewers, { email: newViewer.trim(), addedBy: user.email, addedAt: Date.now() }]); setNewViewer(""); } }}
                  style={{ padding: "11px 18px", borderRadius: 8, border: "none", background: "#7c3aed", color: "#fff", cursor: "pointer", fontWeight: 700 }}>+ Agregar</button>
              </div>
            </div>
            <div style={{ background: T.white, borderRadius: 14, overflow: "hidden", border: `1px solid ${T.border}` }}>
              <div style={{ padding: "12px 16px", borderBottom: `1px solid ${T.border}`, fontSize: 13, fontWeight: 700, color: T.slate }}>
                ğŸ‘ï¸ {viewers.length} espectador{viewers.length !== 1 ? "es" : ""}
              </div>
              {viewers.length === 0 && (
                <div style={{ padding: "32px 20px", textAlign: "center", color: T.muted, fontSize: 13 }}>No hay espectadores registrados aÃºn</div>
              )}
              {viewers.map((v, i) => (
                <div key={i} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "12px 16px", borderBottom: `1px solid ${T.border}` }}>
                  <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                    <div style={{ width: 28, height: 28, borderRadius: 8, background: "#ede9fe", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 14 }}>ğŸ‘ï¸</div>
                    <div>
                      <div style={{ fontSize: 14, fontWeight: 600, color: T.navyMid }}>{v.email}</div>
                      <div style={{ fontSize: 11, color: T.muted }}>Agregado: {v.addedAt ? fmtDate(v.addedAt) : "â€”"} Â· por {v.addedBy}</div>
                    </div>
                  </div>
                  <button onClick={() => onUpdateViewers(viewers.filter((_, j) => j !== i))}
                    style={{ padding: "5px 12px", borderRadius: 20, border: "none", cursor: "pointer", fontSize: 12, fontWeight: 700, background: T.redLight, color: T.red }}>
                    Quitar
                  </button>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

// â”€â”€â”€ Main App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App() {
  const [currentUser, setCurrentUser] = useState(null);
  const [view, setView] = useState("login");
  const [viewAs, setViewAs] = useState("admin"); // admin "Ver como" mode

  const [registros, setRegistros, regOk] = useSharedStorage("mreg-v1-registros", []);
  const [empresas, setEmpresas, empOk] = useSharedStorage("mreg-v1-empresas", EMPRESAS_INIT);
  const [sedes, setSedes, sedOk] = useSharedStorage("mreg-v1-sedes", SEDES_INIT);
  const [admins, setAdmins, admOk] = useSharedStorage("mreg-v1-admins", [{ email: "aescobar@stcanaveral.com", addedBy: "system", addedAt: Date.now() }]);
  const [viewers, setViewers, viewOk] = useSharedStorage("mreg-v1-viewers", []);
  const [guardias, setGuardias, guardOk] = useSharedStorage("mreg-v1-guardias", []);
  const [comercials, setComercials, comOk] = useSharedStorage("mreg-v1-comercials", []);
  const [acuerdos, setAcuerdos, acuOk] = useSharedStorage("mreg-v1-acuerdos", []); // { email, sedeId, addedBy, addedAt }

  // â”€â”€ Offline support â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const online = useOnlineStatus();
  const [syncing, setSyncing] = useState(false);
  const [lastSyncAt, setLastSyncAt] = useState(null);

  // Count pending registros (those saved offline)
  const pendingCount = useMemo(
    () => registros.filter(r => r.pendingSync).length,
    [registros]
  );

  // Auto-sync when connection is restored
  useEffect(() => {
    if (online && pendingCount > 0) {
      handleSync();
    }
  }, [online]); // eslint-disable-line

  const handleSync = useCallback(async () => {
    setSyncing(true);
    try {
      // Mark all pending as synced
      // In production: here you call your API/SharePoint to push each pending record
      const synced = registros.map(r =>
        r.pendingSync ? { ...r, pendingSync: false, syncedAt: Date.now() } : r
      );
      await setRegistros(synced);
      setLastSyncAt(Date.now());
    } catch (e) {
      console.error("Sync error:", e);
    }
    setSyncing(false);
  }, [registros, setRegistros]);

  // Real-time polling every 5s
  useEffect(() => {
    if (!currentUser) return;
    const poll = setInterval(async () => {
      try {
        const r = await window.storage.get("mreg-v1-registros", true);
        if (r) {
          const fresh = JSON.parse(r.value);
          setRegistros(prev => JSON.stringify(fresh) !== JSON.stringify(prev) ? fresh : prev);
        }
      } catch (_) {}
    }, 5000);
    return () => clearInterval(poll);
  }, [currentUser]);

  const isAdmin = useCallback((u) =>
    u && (u.rol === "admin" || admins.some(a => a.email === u.email)),
    [admins]);

  const isViewer = useCallback((u) =>
    u && !isAdmin(u) && (u.rol === "viewer" || viewers.some(v => v.email === u.email)),
    [viewers, isAdmin]);

  const isComercial = useCallback((u) =>
    u && !isAdmin(u) && !isViewer(u) && (u.rol === "comercial" || comercials.some(c => c.email === u.email)),
    [comercials, isAdmin, isViewer]);

  const handleNuevoRegistro = useCallback(async (data) => {
    const resolvedSedeId = data.sedeIdOverride || currentUser.sedeId;
    const sede = sedes.find(s => s.id === resolvedSedeId);
    const maxConsec = registros.length > 0 ? Math.max(...registros.map(r => r.consecutivo || 0)) : 0;
    const newReg = {
      id: `reg-${Date.now()}`,
      consecutivo: maxConsec + 1,
      empresa: data.empresa,
      empresaId: data.empresaId,
      tipo: data.tipo,
      sedeId: resolvedSedeId,
      sedeName: sede?.nombre || "â€”",
      guardiaName: currentUser.nombre,
      guardiaId: currentUser.id,
      gps: data.gps || null,
      timestamp: Date.now(),
      pendingSync: !online,   // flagged for sync when offline
      syncedAt: online ? Date.now() : null,
    };
    await setRegistros([...registros, newReg]);
  }, [registros, sedes, currentUser, setRegistros, online]);

  const handleEditRegistro = useCallback(async (updated) => {
    await setRegistros(registros.map(r => r.id === updated.id ? updated : r));
  }, [registros, setRegistros]);

  const handleDeleteRegistro = useCallback(async (id) => {
    await setRegistros(registros.filter(r => r.id !== id));
  }, [registros, setRegistros]);

  // Loading
  if (!regOk || !empOk || !sedOk || !admOk || !viewOk || !guardOk || !comOk || !acuOk) return (
    <div style={{ minHeight: "100vh", background: "#05200b", display: "flex", alignItems: "center", justifyContent: "center" }}>
      <div style={{ textAlign: "center", color: "#fff" }}>
        <img src={LOGO_SRC} alt="CaÃ±averal" style={{ width: 80, height: 80, borderRadius: "50%", objectFit: "cover", marginBottom: 16, boxShadow: "0 4px 20px rgba(0,0,0,.3)" }} />
        <div style={{ fontSize: 16, fontWeight: 700, color: "rgba(255,255,255,.7)" }}>Cargando...</div>
        <div style={{ display: "flex", justifyContent: "center", marginTop: 16 }}><Spinner /></div>
      </div>
    </div>
  );

  if (!currentUser) return (
    <LoginScreen onLogin={u => { setCurrentUser(u); setView("main"); }} admins={admins} viewers={viewers} sedes={sedes} guardias={guardias} comercials={comercials} />
  );

  const admin = isAdmin(currentUser);
  const viewer = isViewer(currentUser);
  const comercial = isComercial(currentUser);

  // First sede available for security preview
  const firstSede = sedes.find(s => s.activa);

  if (view === "admin-panel" && admin) return (
    <AdminPanel user={currentUser} sedes={sedes} empresas={empresas} admins={admins} viewers={viewers} guardias={guardias} comercials={comercials}
      onUpdateSedes={setSedes} onUpdateEmpresas={setEmpresas} onUpdateAdmins={setAdmins} onUpdateViewers={setViewers} onUpdateGuardias={setGuardias} onUpdateComercials={setComercials}
      onClose={() => setView("main")} />
  );

  if (admin && viewAs === "security") return (
    <SecurityView
      user={{ ...currentUser, sedeId: firstSede?.id || null, nombre: currentUser.nombre + " (vista previa)" }}
      sedes={sedes} empresas={empresas} registros={registros}
      onNuevoRegistro={handleNuevoRegistro}
      onLogout={() => setViewAs("admin")}
      online={online} pendingCount={pendingCount} syncing={syncing} onSync={handleSync}
      viewAsBar={<ViewAsBar viewAs={viewAs} setViewAs={setViewAs} />} />
  );

  if (admin) return (
    <AdminDashboard user={currentUser} registros={registros} sedes={sedes} empresas={empresas}
      onEdit={handleEditRegistro} onDelete={handleDeleteRegistro} onNuevoRegistro={handleNuevoRegistro}
      onUpdateEmpresas={setEmpresas} acuerdos={acuerdos} onUpdateAcuerdos={setAcuerdos}
      onLogout={() => { setCurrentUser(null); setView("login"); try { getMsal().logoutRedirect(); } catch(_) {} }}
      onOpenPanel={() => setView("admin-panel")} isViewer={viewAs === "viewer"} isComercial={viewAs === "comercial"}
      viewAs={viewAs} onSetViewAs={setViewAs}
      online={online} pendingCount={pendingCount} syncing={syncing} onSync={handleSync} lastSyncAt={lastSyncAt} />
  );

  if (comercial) return (
    <AdminDashboard user={currentUser} registros={registros} sedes={sedes} empresas={empresas}
      onEdit={handleEditRegistro} onDelete={handleDeleteRegistro} onNuevoRegistro={handleNuevoRegistro}
      onUpdateEmpresas={setEmpresas} acuerdos={acuerdos} onUpdateAcuerdos={setAcuerdos}
      onLogout={() => { setCurrentUser(null); setView("login"); try { getMsal().logoutRedirect(); } catch(_) {} }}
      onOpenPanel={() => {}} isViewer={false} isComercial={true}
      online={online} pendingCount={pendingCount} syncing={syncing} onSync={handleSync} lastSyncAt={lastSyncAt} />
  );

  if (viewer) return (
    <AdminDashboard user={currentUser} registros={registros} sedes={sedes} empresas={empresas}
      onEdit={handleEditRegistro} onDelete={handleDeleteRegistro} onNuevoRegistro={handleNuevoRegistro}
      onUpdateEmpresas={setEmpresas} acuerdos={acuerdos} onUpdateAcuerdos={null}
      onLogout={() => { setCurrentUser(null); setView("login"); try { getMsal().logoutRedirect(); } catch(_) {} }}
      onOpenPanel={() => {}} isViewer={true} isComercial={false}
      online={online} pendingCount={pendingCount} syncing={syncing} onSync={handleSync} lastSyncAt={lastSyncAt} />
  );

  return (
    <SecurityView user={currentUser} sedes={sedes} empresas={empresas} registros={registros}
      onNuevoRegistro={handleNuevoRegistro}
      onLogout={() => { setCurrentUser(null); setView("login"); try { getMsal().logoutPopup(); } catch(_) {} }}
      online={online} pendingCount={pendingCount} syncing={syncing} onSync={handleSync} />
  );
}

// â”€â”€â”€ Mount â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _root = ReactDOM.createRoot(document.getElementById("root"));
_root.render(React.createElement(App));

</script>
</body>
</html>
